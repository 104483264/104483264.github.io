<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>acwing-springboot 6. 实现微服务：匹配系统 | 卑微小陈的Blog</title><meta name="keywords" content="springboot"><meta name="author" content="卑微小陈"><meta name="copyright" content="卑微小陈"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="流程分析 整个匹配的过程是异步过程，也就是在 Matching system 中执行匹配的过程，会执行一个未知的时间，当出现符合条件的匹配结果时，才会立即将结果返回给前端。这种流程很难用之前的 Http 来达到预期效果（http 为请求一次返回一次，且一般立即响应）。对于匹配系统，请求一次，返回的时间位置，而且可能多次返回。 用 websocket 协议，不仅客户端可以向服务器主动发送请求，服务器">
<meta property="og:type" content="article">
<meta property="og:title" content="acwing-springboot 6. 实现微服务：匹配系统">
<meta property="og:url" content="https://104483264.github.io/posts/c0a8ef92.html">
<meta property="og:site_name" content="卑微小陈的Blog">
<meta property="og:description" content="流程分析 整个匹配的过程是异步过程，也就是在 Matching system 中执行匹配的过程，会执行一个未知的时间，当出现符合条件的匹配结果时，才会立即将结果返回给前端。这种流程很难用之前的 Http 来达到预期效果（http 为请求一次返回一次，且一般立即响应）。对于匹配系统，请求一次，返回的时间位置，而且可能多次返回。 用 websocket 协议，不仅客户端可以向服务器主动发送请求，服务器">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://w.wallhaven.cc/full/jx/wallhaven-jx9gyy.png">
<meta property="article:published_time" content="2022-11-02T16:25:00.000Z">
<meta property="article:modified_time" content="2022-11-03T03:38:08.198Z">
<meta property="article:author" content="卑微小陈">
<meta property="article:tag" content="springboot">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://w.wallhaven.cc/full/jx/wallhaven-jx9gyy.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://104483264.github.io/posts/c0a8ef92"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="manifest" href="/manifest.json"/><meta name="msapplication-TileColor" content="#425aef"/><link rel="apple-touch-icon" sizes="180x180" href="/img/siteicon/128.png"/><link rel="icon" type="image/png" sizes="32x32" href="/img/siteicon/32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/img/siteicon/16.png"/><link rel="mask-icon" href="/img/siteicon/128.png" color="#5bbad5"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'acwing-springboot 6. 实现微服务：匹配系统',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-11-03 11:38:08'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu@1.1.8/lib/clock.min.css" /><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-blog@2.0.4/css/runtime/runtime.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-swiper-anzhiyu@1.0.4/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-swiper-anzhiyu@1.0.4/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/hexo-filter-gitcalendar/lib/gitcalendar.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://cdn.cbd.int/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="卑微小陈的Blog" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">18</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">2</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><i class="fa-fw fas fa-home faa-tada"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><i class="fa-fw fas fa-archive faa-tada"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/artitalk/"><i class="fa-fw fas fa-comment-dots faa-tada"></i><span> 闲言碎语</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/music/"><i class="fa-fw fas fa-music faa-tada"></i><span> 音乐馆</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/categories/"><i class="fa-fw fas fa-folder-open faa-tada"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/fcircle/"><i class="fa-fw fab fa-artstation faa-tada"></i><span> 朋友圈</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><i class="fa-fw fas fa-envelope faa-tada"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/link/"><i class="fa-fw fas fa-link faa-tada"></i><span> 友人帐</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/bangumis/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-bilibili1"></use></svg><span> 追番</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-zhifeiji"></use></svg><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://w.wallhaven.cc/full/jx/wallhaven-jx9gyy.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">卑微小陈的Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><i class="fa-fw fas fa-home faa-tada"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/archives/"><i class="fa-fw fas fa-archive faa-tada"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/artitalk/"><i class="fa-fw fas fa-comment-dots faa-tada"></i><span> 闲言碎语</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/music/"><i class="fa-fw fas fa-music faa-tada"></i><span> 音乐馆</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/categories/"><i class="fa-fw fas fa-folder-open faa-tada"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/fcircle/"><i class="fa-fw fab fa-artstation faa-tada"></i><span> 朋友圈</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><i class="fa-fw fas fa-envelope faa-tada"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/link/"><i class="fa-fw fas fa-link faa-tada"></i><span> 友人帐</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/bangumis/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-bilibili1"></use></svg><span> 追番</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-zhifeiji"></use></svg><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">acwing-springboot 6. 实现微服务：匹配系统</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-11-02T16:25:00.000Z" title="发表于 2022-11-03 00:25:00">2022-11-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-11-03T03:38:08.198Z" title="更新于 2022-11-03 11:38:08">2022-11-03</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/acwing%E9%A1%B9%E7%9B%AE/">acwing项目</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">12.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>51分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="acwing-springboot 6. 实现微服务：匹配系统"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_9bf016c45a-image-20220809232853003.png" alt="image-20220809232853003.png"></p>
<p>整个匹配的过程是异步过程，也就是在 Matching system 中执行匹配的过程，会执行一个未知的时间，当出现符合条件的匹配结果时，才会立即将结果返回给前端。这种流程很难用之前的 Http 来达到预期效果（http 为请求一次返回一次，且一般立即响应）。对于匹配系统，请求一次，返回的时间位置，而且可能多次返回。</p>
<p>用 websocket 协议，不仅客户端可以向服务器主动发送请求，服务器也可以主动向客户端发送请求，是一种对称的通信方式。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_dd07979c5b-image-20220809233425880.png" alt="image-20220809233425880.png"></p>
<p>之前的地图生成方式，是在用户本地（浏览器中）随机生成，如果两名玩家都在本地实现地图，地图就会产生冲突。因此，需要将生成地图的整个过程，由服务器统一完成。此外，判断游戏是否失败的逻辑（蛇撞击），如果在用户本地（浏览器）中实现，就可能会导致用户作弊。所以，不仅是生成地图，而是整个游戏的过程（蛇的移动、判定），都要做服务器端统一完成，服务器端的相关参数、判定结果返回给前端，前端只用来渲染画面，不做任何判定逻辑。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_0a1c67555b-image-20220809235633315.png" alt="image-20220809235633315.png"></p>
<h3 id="websocket-原理"><a href="#websocket-原理" class="headerlink" title="websocket 原理"></a>websocket 原理</h3><p>将前端建立的每个 websocket 连接在后端维护起来</p>
<p>添加<code>consumer.WebSocketServer</code>类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.backend.consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.websocket.*;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.PathParam;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.ServerEndpoint;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ServerEndpoint(&quot;/websocket/&#123;token&#125;&quot;)</span>  <span class="comment">// 注意不要以&#x27;/&#x27;结尾</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketServer</span> &#123;</span><br><span class="line">    <span class="meta">@OnOpen</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session, <span class="meta">@PathParam(&quot;token&quot;)</span> String token)</span> &#123;</span><br><span class="line">        <span class="comment">// 建立连接</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnClose</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 关闭链接</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnMessage</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message, Session session)</span> &#123;</span><br><span class="line">        <span class="comment">// 从Client接收消息</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnError</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Session session, Throwable error)</span> &#123;</span><br><span class="line">        error.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在用户开始匹配的时候，每个 client 向后端发送一个请求，就会在后端开辟一个线程，创建并维护一个 websocket 连接（实际上就是 new 一个 WebSocketServer 类的实例）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">WebSocketServer</span> <span class="variable">client1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebSocketServer</span>();</span><br><span class="line"><span class="type">WebSocketServer</span> <span class="variable">client2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebSocketServer</span>();</span><br></pre></td></tr></table></figure>
<p>后端接收到请求之后，将信息发送给匹配系统。</p>
<h2 id="集成-WebSocket"><a href="#集成-WebSocket" class="headerlink" title="集成 WebSocket"></a>集成 WebSocket</h2><p>1）在<code>pom.xml</code>文件中添加依赖：</p>
<ul>
<li><code>spring-boot-starter-websocket</code></li>
<li><code>fastjson</code></li>
</ul>
<p>2）添加<code>config.WebSocketConfig</code>配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.backend.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.server.standard.ServerEndpointExporter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ServerEndpointExporter <span class="title function_">serverEndpointExporter</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServerEndpointExporter</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3）添加<code>consumer.WebSocketServer</code>类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.backend.consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.*;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.PathParam;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.ServerEndpoint;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ServerEndpoint(&quot;/websocket/&#123;token&#125;&quot;)</span>  <span class="comment">// 注意不要以&#x27;/&#x27;结尾</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketServer</span> &#123;</span><br><span class="line">    <span class="meta">@OnOpen</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session, <span class="meta">@PathParam(&quot;token&quot;)</span> String token)</span> &#123;</span><br><span class="line">        <span class="comment">//  建立连接时自动调用</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnClose</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 关闭链接时自动调用</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnMessage</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message, Session session)</span> &#123;</span><br><span class="line">        <span class="comment">// Server从Client接收消息时触发</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnError</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Session session, Throwable error)</span> &#123;</span><br><span class="line">        error.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面最核心的一个函数是<code>onMessage</code>，负责 Server 从 Client 接收消息时处理相关逻辑。那如何在通过后端，向前端 client 发送信息呢？</p>
<p>定义<code>Session</code>对象，每个连接本质上是通过<code>Session</code>维护</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>
<p>新增<code>sendMessage</code>函数，用于后端向当前连接发送信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(String message)</span>&#123;</span><br><span class="line">    <span class="comment">// Server发送消息</span></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>.session)&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.session.getBasicRemote().sendText(message);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外还需要存储下每个<code>connection</code>对应的用户是谁，这样才能清楚哪两个用户之间发生了匹配，用户信息也要存储到<code>Session</code>中。并且需要根据用户的<code>ID</code>，找到相应的<code>WebSocketServer</code>连接是哪一个，所以将两者的映射关系存储在<code>ConcurrentHashMap</code>中，<code>ConcurrentHashMap</code>是一个线程安全的哈希表</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> User user;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ConcurrentHashMap&lt;Integer,WebSocketServer&gt;</span><br><span class="line">    userConnectionInfo = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br></pre></td></tr></table></figure>
<p>由于<code>WebSocket</code>不属于<code>Spring</code>的一个组件，不是单例模式，因此，注入<code>mapper</code>的方式有些区别</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserMapper</span><span class="params">(UserMapper userMapper)</span>&#123;</span><br><span class="line">    WebSocketServer.userMapper = userMapper;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在建立连接时，需要建立用户 ID 与<code>WebSocketServer</code>实例的映射</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OnOpen</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session, <span class="meta">@PathParam(&quot;token&quot;)</span> String token)</span> &#123;</span><br><span class="line">    <span class="comment">// 建立连接时自动调用</span></span><br><span class="line">    <span class="built_in">this</span>.session = session;</span><br><span class="line">    System.out.println(<span class="string">&quot;Connected!&quot;</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">userId</span> <span class="operator">=</span> Integer.parseInt(token);<span class="comment">//假设token为userId</span></span><br><span class="line">    <span class="built_in">this</span>.user = userMapper.selectById(userId);</span><br><span class="line">    userConnectionInfo.put(userId, <span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在关闭连接时，删除这种映射</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OnClose</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 关闭链接时自动调用</span></span><br><span class="line">    System.out.println(<span class="string">&quot;Disconnected!&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.user != <span class="literal">null</span>)&#123;</span><br><span class="line">        userConnectionInfo.remove(<span class="built_in">this</span>.user.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时的<code>WebSocketServer.java</code>为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ServerEndpoint(&quot;/websocket/&#123;token&#125;&quot;)</span>  <span class="comment">// 注意不要以&#x27;/&#x27;结尾</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> User user;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ConcurrentHashMap&lt;Integer,WebSocketServer&gt;</span><br><span class="line">            userConnectionInfo = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserMapper</span><span class="params">(UserMapper userMapper)</span>&#123;</span><br><span class="line">        WebSocketServer.userMapper = userMapper;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@OnOpen</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session, <span class="meta">@PathParam(&quot;token&quot;)</span> String token)</span> &#123;</span><br><span class="line">        <span class="comment">// 建立连接时自动调用</span></span><br><span class="line">        <span class="built_in">this</span>.session = session;</span><br><span class="line">        System.out.println(<span class="string">&quot;Connected!&quot;</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">userId</span> <span class="operator">=</span> Integer.parseInt(token);<span class="comment">//假设token为userId</span></span><br><span class="line">        <span class="built_in">this</span>.user = userMapper.selectById(userId);</span><br><span class="line">        userConnectionInfo.put(userId, <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnClose</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 关闭链接时自动调用</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Disconnected!&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">this</span>.user != <span class="literal">null</span>)&#123;</span><br><span class="line">            userConnectionInfo.remove(<span class="built_in">this</span>.user.getId());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnMessage</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message, Session session)</span> &#123;</span><br><span class="line">        <span class="comment">// Server从Client接收消息时触发</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Receive message!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnError</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Session session, Throwable error)</span> &#123;</span><br><span class="line">        error.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(String message)</span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>.session)&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="built_in">this</span>.session.getBasicRemote().sendText(message);</span><br><span class="line">            &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4）配置<code>config.SecurityConfig</code>，将<code>/websocket/&#123;token&#125;</code>一类的<code>url</code>链接全部放行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    web.ignoring().antMatchers(<span class="string">&quot;/websocket/**&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="接口调试"><a href="#接口调试" class="headerlink" title="接口调试"></a>接口调试</h2><p>我们在<code>views\pk\PkIndexView.vue</code>中对<code>WebSocket</code>进行测试</p>
<p>期望在当前组件被加载成功之后，建立一个连接。</p>
<p>需要引入<code>vue</code>的两个与生命周期有关的函数</p>
<ul>
<li><code>onMounted</code>是当组件被挂载完成之后执行的函数</li>
<li><code>onUnmounted</code>是当组件被卸载之后执行的函数</li>
</ul>
<p>同时，需要将<code>WebSocket</code>存储到全局变量中，在 store 中开一个新的 module 用于存储所有和 pk 相关的全局变量</p>
<p><code>src\store\pk.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">state</span>: &#123;</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&quot;matching&quot;</span>, <span class="comment">//matching表示匹配界面 playing表示对战界面</span></span><br><span class="line">    <span class="attr">socket</span>: <span class="literal">null</span>, <span class="comment">//存储前后端建立的connection</span></span><br><span class="line">    <span class="attr">opponent_username</span>: <span class="string">&quot;&quot;</span>, <span class="comment">//对手名</span></span><br><span class="line">    <span class="attr">opponent_photo</span>: <span class="string">&quot;&quot;</span>, <span class="comment">//对手头像</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">mutations</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">actions</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">modules</span>: &#123;&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>由于在成功创建连接之后，需要将连接信息，存储到全局变量中</p>
<p>所以需要在<code>src\store\pk.js</code>实现几个辅助函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">state</span>: &#123;</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&quot;matching&quot;</span>, <span class="comment">//matching表示匹配界面 playing表示对战界面</span></span><br><span class="line">    <span class="attr">socket</span>: <span class="literal">null</span>, <span class="comment">//存储前后端建立的connection</span></span><br><span class="line">    <span class="attr">opponent_username</span>: <span class="string">&quot;&quot;</span>, <span class="comment">//对手名</span></span><br><span class="line">    <span class="attr">opponent_photo</span>: <span class="string">&quot;&quot;</span>, <span class="comment">//对手头像</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">mutations</span>: &#123;</span><br><span class="line">    <span class="title function_">updateSocket</span>(<span class="params">state, socket</span>) &#123;</span><br><span class="line">      state.<span class="property">socket</span> = socket;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">updateOpponent</span>(<span class="params">state, opponent</span>) &#123;</span><br><span class="line">      state.<span class="property">opponent_username</span> = opponent.<span class="property">username</span>;</span><br><span class="line">      state.<span class="property">opponent_photo</span> = opponent.<span class="property">photo</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">updateStatus</span>(<span class="params">state, status</span>) &#123;</span><br><span class="line">      state.<span class="property">status</span> = status;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">actions</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">modules</span>: &#123;&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>然后在<code>views\pk\PkIndexView.vue</code>引入全局变量<code>useStore</code></p>
<p>在当前组件被挂载的时候（可以简单理解为页面被打开的时候），也就是<code>onMounted</code>执行的时候，我们需要创建<code>connection</code>，在<code>onUnmounted</code>执行的时候，关闭连接。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">components</span>: &#123;</span><br><span class="line">    <span class="title class_">PlayGround</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> store = <span class="title function_">useStore</span>();</span><br><span class="line">    <span class="keyword">const</span> socketUrl = <span class="string">`ws://127.0.0.1:3000/websocket/<span class="subst">$&#123;store.state.user.id&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">let</span> socket = <span class="literal">null</span>;</span><br><span class="line">    <span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      socket = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(socketUrl);</span><br><span class="line">      socket.<span class="property">onopen</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">//如果连接成功，将socket存储到全局变量中</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;connected!&quot;</span>);</span><br><span class="line">        store.<span class="title function_">commit</span>(<span class="string">&quot;updateSocket&quot;</span>, socket);</span><br><span class="line">      &#125;;</span><br><span class="line">      socket.<span class="property">onmessage</span> = <span class="function">(<span class="params">msg</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(msg.<span class="property">data</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">      &#125;;</span><br><span class="line">      socket.<span class="property">onclose</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;disconnected!&quot;</span>);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">onUnmounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      socket.<span class="title function_">close</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="建立连接"><a href="#建立连接" class="headerlink" title="建立连接"></a>建立连接</h3><p>当进入到对战页面时，可以在后端和浏览器的控制台中看到连接成功的输出</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_513c340f5b-image-20220810145912567.png" alt="image-20220810145912567.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_668e86f85b-image-20220810145928993.png" alt="image-20220810145928993.png"></p>
<p>此时如果切换到其他页面，又会断开连接</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_7e5a1edb5b-image-20220810150031718.png" alt="image-20220810150031718.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_ab05a5065b-image-20220810150017457.png" alt="image-20220810150017457.png"></p>
<p>注意如果刷新页面，就会先断开连接，后建立连接</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_c20702c95b-image-20220810150242024.png" alt="image-20220810150242024.png"></p>
<p>而且，必须要在页面卸载时，关闭连接</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">onUnmounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  socket.<span class="title function_">close</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>否则，切换到其他页面的时候，没有关闭连接，但是在每一次进来的时候，又会创建连接</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_e4255aef5b-image-20220810150549415.png" alt="image-20220810150549415.png"></p>
<p>刷新或者关闭时，会关闭所有的连接，从输出看出不止一个</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_f771b4f25b-image-20220810150637938.png" alt="image-20220810150637938.png"></p>
<p>所以，如果不进行正常关闭，在切换到其他页面时，旧连接不会关闭，因此会产生很多冗余的连接。</p>
<p>在成功连接后，后端输出获取到的用户信息如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_0808b4e75b-image-20220810151904289.png" alt="image-20220810151904289.png"></p>
<p>此时建立连接时，是直接将用户的 ID 传输过来，但这样显然是不安全的，因为前端可以通过修改<code>&#123;token&#125;</code>的方式，伪装成任意一个用户的身份建立连接，因此需要添加验证，这里仍然是使用<code>Jwt</code>进行验证</p>
<h3 id="Jwt-验证"><a href="#Jwt-验证" class="headerlink" title="Jwt 验证"></a>Jwt 验证</h3><p>前端直接将<code>jwt-token</code>传过去</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> socketUrl = <span class="string">`ws://127.0.0.1:3000/websocket/<span class="subst">$&#123;store.state.user.token&#125;</span>`</span>;</span><br></pre></td></tr></table></figure>
<p>后端验证的方式，在<code>config.filter.JwtAuthenticationTokenFilter</code>已经给出</p>
<p>那就是就是如果能从<code>token</code>中解析出<code>userId</code>就认为是合法的，否则就是不合法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">String userid;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> JwtUtil.parseJWT(token);</span><br><span class="line">    <span class="comment">//如果能解析出userid表示合法 否则不合法</span></span><br><span class="line">    userid = claims.getSubject();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了日后方便，将这段代码提出，放在一个单独的工具类<code>consumer.utils.JwtAuthentication</code>中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.backend.consumer.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kob.backend.utils.JwtUtil;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Claims;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthentication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title function_">getUserId</span><span class="params">(String token)</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">userId</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> JwtUtil.parseJWT(token);</span><br><span class="line">            <span class="comment">//如果能解析出userid表示合法 否则不合法</span></span><br><span class="line">            userId = Integer.parseInt(claims.getSubject());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> userId;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时<code>WebSocketServer.java</code>中<code>onOpen</code>函数体更新为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OnOpen</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session, <span class="meta">@PathParam(&quot;token&quot;)</span> String token)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 建立连接时自动调用</span></span><br><span class="line">    <span class="built_in">this</span>.session = session;</span><br><span class="line">    System.out.println(<span class="string">&quot;Connected!&quot;</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">userId</span> <span class="operator">=</span> JwtAuthentication.getUserId(token);</span><br><span class="line">    <span class="built_in">this</span>.user = userMapper.selectById(userId);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.user != <span class="literal">null</span>)</span><br><span class="line">        userConnectionInfo.put(userId, <span class="built_in">this</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">this</span>.session.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样就能够成功实现<code>jwt</code>验证</p>
<h2 id="前端实现"><a href="#前端实现" class="headerlink" title="前端实现"></a>前端实现</h2><p>此时前端还只有对战界面，并没有匹配界面，我们需要实现匹配界面，以及匹配界面和对战界面的切换</p>
<p>与切换有关的全局变量，就是在<code>pk.js</code>中定义的<code>status</code>， <code>matching</code>表示匹配界面，<code>playing</code>表示对战界面</p>
<p>那就需要当<code>status</code>为<code>playing</code>的时候再显示对战页面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;PlayGround v-if=&quot;$store.state.pk.status === &#x27;playing&#x27;&quot; /&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>
<p>并且需要创建一个新的组件<code>MatchGround.vue</code>，用于表示匹配界面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;matchground&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;row&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;col-6&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;user_photo&quot;&gt;</span><br><span class="line">          &lt;img :src=&quot;$store.state.user.photo&quot; alt=&quot;&quot; /&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class=&quot;user_username&quot;&gt;</span><br><span class="line">          &#123;&#123; $store.state.user.username &#125;&#125;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;div class=&quot;col-6&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;user_photo&quot;&gt;</span><br><span class="line">          &lt;img :src=&quot;$store.state.pk.opponent_photo&quot; alt=&quot;&quot; /&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class=&quot;user_username&quot;&gt;</span><br><span class="line">          &#123;&#123; $store.state.pk.opponent_username &#125;&#125;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div class=&quot;row&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;col-12&quot; style=&quot;text-align:center; padding-top:12vh&quot;&gt;</span><br><span class="line">        &lt;button @click=&quot;click_match_btn&quot; class=&quot;btn btn-success btn-lg&quot;&gt;</span><br><span class="line">          &#123;&#123; match_btn_info &#125;&#125;</span><br><span class="line">        &lt;/button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>
<p>为按钮绑定一个<code>click_match_btn</code>触发函数，当点击”开始匹配”，使用<code>WebSocket</code>的<code>sent</code>API 向后端发送包含<code>event:&quot;start-matching&quot;</code>的字符串（注意，<code>JSON.stringify</code>是将<code>JSON</code>格式处理为字符串，后续还可以恢复<code>JSON</code>格式）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; useStore &#125; <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="title function_">setup</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> store = <span class="title function_">useStore</span>();</span><br><span class="line">        <span class="keyword">let</span> match_btn_info = <span class="title function_">ref</span>(<span class="string">&quot;开始匹配&quot;</span>);</span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">click_match_btn</span> = (<span class="params"></span>) =&gt;&#123;</span><br><span class="line">            <span class="keyword">if</span>(match_btn_info.<span class="property">value</span> === <span class="string">&quot;开始匹配&quot;</span>)&#123;</span><br><span class="line">                match_btn_info.<span class="property">value</span> = <span class="string">&quot;取消&quot;</span>;</span><br><span class="line">                <span class="comment">//JSON.stringify将JSON转换为字符串</span></span><br><span class="line">                store.<span class="property">state</span>.<span class="property">pk</span>.<span class="property">socket</span>.<span class="title function_">sent</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line">                    <span class="attr">event</span>:<span class="string">&quot;start-matching&quot;</span>,</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                match_btn_info.<span class="property">value</span> = <span class="string">&quot;开始匹配&quot;</span>;</span><br><span class="line">                store.<span class="property">state</span>.<span class="property">pk</span>.<span class="property">socket</span>.<span class="title function_">sent</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line">                    <span class="attr">event</span>:<span class="string">&quot;stop-matching&quot;</span>,</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span>&#123;</span><br><span class="line">            match_btn_info,</span><br><span class="line">            click_match_btn,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>后端收到请求时，就会将<code>message</code>字符串解析为<code>JSON</code>格式，然后根据<code>event</code>值来分配给不同的任务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startMatching</span><span class="params">()</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;start matching!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">stopMatching</span><span class="params">()</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;stop matching!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@OnMessage</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message, Session session)</span> &#123;<span class="comment">//当做路由 分配任务</span></span><br><span class="line">    <span class="comment">// Server从Client接收消息时触发</span></span><br><span class="line">    System.out.println(<span class="string">&quot;Receive message!&quot;</span>);</span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">data</span> <span class="operator">=</span> JSONObject.parseObject(message);<span class="comment">//将字符串解析成JSON</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">event</span> <span class="operator">=</span> data.getString(<span class="string">&quot;event&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&quot;start-matching&quot;</span>.equals(event))&#123;<span class="comment">//防止event为空的异常</span></span><br><span class="line">        startMatching();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;stop-matching&quot;</span>.equals(event)) &#123;</span><br><span class="line">        stopMatching();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在后端需要建立一个线程安全的 Set 作为匹配池</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> CopyOnWriteArraySet&lt;User&gt;</span><br><span class="line">        matchpool = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArraySet</span>&lt;&gt;();</span><br></pre></td></tr></table></figure>
<p>然后在相应的时间添加和删除</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OnClose</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 关闭链接时自动调用</span></span><br><span class="line">    System.out.println(<span class="string">&quot;Disconnected!&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.user != <span class="literal">null</span>)&#123;</span><br><span class="line">        userConnectionInfo.remove(<span class="built_in">this</span>.user.getId());</span><br><span class="line">        matchpool.remove(<span class="built_in">this</span>.user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startMatching</span><span class="params">()</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;start matching!&quot;</span>);</span><br><span class="line">    matchpool.add(<span class="built_in">this</span>.user);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">stopMatching</span><span class="params">()</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;stop matching!&quot;</span>);</span><br><span class="line">    matchpool.remove(<span class="built_in">this</span>.user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于现在还没有实现微服务，暂时先实现一个傻瓜式的匹配，也就是匹配池中大于等于两个用户的时候，就实现两两匹配，也就是两个用户<code>user1</code>和<code>user2</code>，并通过两个用户自己的连接，告诉前端匹配成功的相关消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startMatching</span><span class="params">()</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;start matching!&quot;</span>);</span><br><span class="line">    matchpool.add(<span class="built_in">this</span>.user);</span><br><span class="line">    <span class="keyword">while</span> (matchpool.size() &gt;= <span class="number">2</span>)&#123;</span><br><span class="line">        Iterator&lt;User&gt; iterator = matchpool.iterator();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user2</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">        matchpool.remove(user1);</span><br><span class="line">        matchpool.remove(user2);</span><br><span class="line">        <span class="comment">//分别给user1和user2传送消息告诉他们匹配成功了</span></span><br><span class="line">        <span class="comment">//通过user1的连接向user1发消息</span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">resp1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        resp1.put(<span class="string">&quot;event&quot;</span>,<span class="string">&quot;start-matching&quot;</span>);</span><br><span class="line">        resp1.put(<span class="string">&quot;opponent_username&quot;</span>,user2.getUsername());</span><br><span class="line">        resp1.put(<span class="string">&quot;opponent_photo&quot;</span>,user2.getPhoto());</span><br><span class="line">        <span class="type">WebSocketServer</span> <span class="variable">webSocketServer1</span> <span class="operator">=</span> userConnectionInfo.get(user1.getId());<span class="comment">//获取user1的连接</span></span><br><span class="line">        webSocketServer1.sendMessage(resp1.toJSONString());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//通过user2的连接向user2发消息</span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">resp2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        resp2.put(<span class="string">&quot;event&quot;</span>,<span class="string">&quot;start-matching&quot;</span>);</span><br><span class="line">        resp2.put(<span class="string">&quot;opponent_username&quot;</span>,user1.getUsername());</span><br><span class="line">        resp2.put(<span class="string">&quot;opponent_photo&quot;</span>,user1.getPhoto());</span><br><span class="line">        <span class="type">WebSocketServer</span> <span class="variable">webSocketServer2</span> <span class="operator">=</span> userConnectionInfo.get(user2.getId());</span><br><span class="line">        webSocketServer2.sendMessage(resp2.toJSONString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在前端的<code>PkIndexView.vue</code>中，当接收到后端发送的消息之后，相关逻辑的实现在<code>onmessage</code>函数中</p>
<p>如果匹配成功，就要更新对手信息</p>
<h3 id="匹配测试"><a href="#匹配测试" class="headerlink" title="匹配测试"></a>匹配测试</h3><p>注意，需要两个用户进行测试的话，必须在两个不同的浏览器中。一个浏览器只能允许同时登录一个用户，因为在<code>Local Storage</code>中会共用一个<code>jwt_token</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_23ab86e25b-image-20220810182946774.png" alt="image-20220810182946774.png"></p>
<p>前端如何匹配成功，就更新对手的用户名和头像。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">PlayGround</span> <span class="keyword">from</span> <span class="string">&quot;../../components/PlayGround.vue&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">MatchGround</span> <span class="keyword">from</span> <span class="string">&quot;../../components/MatchGround.vue&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; onMounted &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; onUnmounted &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useStore &#125; <span class="keyword">from</span> <span class="string">&quot;vuex&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">components</span>: &#123;</span><br><span class="line">    <span class="title class_">PlayGround</span>,</span><br><span class="line">    <span class="title class_">MatchGround</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> store = <span class="title function_">useStore</span>();</span><br><span class="line">    <span class="keyword">const</span> socketUrl = <span class="string">`ws://127.0.0.1:3000/websocket/<span class="subst">$&#123;store.state.user.token&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">let</span> socket = <span class="literal">null</span>;</span><br><span class="line">    <span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      store.<span class="title function_">commit</span>(<span class="string">&quot;updateOpponent&quot;</span>, &#123;</span><br><span class="line">        <span class="attr">username</span>: <span class="string">&quot;我的对手&quot;</span>,</span><br><span class="line">        <span class="attr">photo</span>:</span><br><span class="line">          <span class="string">&quot;https://cdn.acwing.com/media/article/image/2022/08/09/1_1db2488f17-anonymous.png&quot;</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">      socket = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(socketUrl);</span><br><span class="line">      socket.<span class="property">onopen</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">//如果连接成功，将socket存储到全局变量中</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;connected!&quot;</span>);</span><br><span class="line">        store.<span class="title function_">commit</span>(<span class="string">&quot;updateSocket&quot;</span>, socket);</span><br><span class="line">      &#125;;</span><br><span class="line">      socket.<span class="property">onmessage</span> = <span class="function">(<span class="params">msg</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(msg.<span class="property">data</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">        <span class="keyword">if</span> (data.<span class="property">event</span> === <span class="string">&quot;start-matching&quot;</span>) &#123;</span><br><span class="line">          store.<span class="title function_">commit</span>(<span class="string">&quot;updateOpponent&quot;</span>, &#123;</span><br><span class="line">            <span class="attr">username</span>: data.<span class="property">opponent_username</span>,</span><br><span class="line">            <span class="attr">photo</span>: data.<span class="property">opponent_photo</span>,</span><br><span class="line">          &#125;);</span><br><span class="line">          <span class="comment">// store.commit(&quot;updateStatus&quot;,&quot;playing&quot;)</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">      socket.<span class="property">onclose</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;disconnected!&quot;</span>);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">onUnmounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      socket.<span class="title function_">close</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_749305485b-image-20220810184626741.png" alt="image-20220810184626741.png"><br>`<br>然后在匹配成功之后，设置延迟两秒显示，然后跳转到对战页面</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_94da40245b-image-20220810185856530.png" alt="image-20220810185856530.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_a56e0f745b-image-20220810192234151.png" alt="image-20220810192234151.png"></p>
<p>如果切换其他页面再切换回来的时候，地图又发生了变化，期望点击其他页面的时候自动放弃，再切换回来的时候，重新回到匹配页面。</p>
<p>那就需要在卸载页面（<code>onUnmounted</code>）的时候，不仅需要断开连接，同时还要将状态切换为<code>matching</code>状态。</p>
<p>但此时有一个很大的问题，就是两个人的游戏地图不一致。这是因为地图是在浏览器本地生成，为了解决同步问题，需要由服务器统一接管。</p>
<h2 id="地图同步"><a href="#地图同步" class="headerlink" title="地图同步"></a>地图同步</h2><p>接下来需要在服务器端实现之前分析的 Game 流程</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_b4eccecd5b-image-20220809235633315.png" alt="image-20220809235633315.png"></p>
<p>添加<code>consumer.utils.Game.java</code>，用于管理整个游戏流程</p>
<p>参考<code>assets\scripts\GameMap.js</code></p>
<p>画地图参考<code>GameMap.js</code>中<code>create_walls()</code>函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Game</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> Integer rows;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> Integer cols;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> Integer inner_walls_count;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> <span class="type">int</span>[][] g;</span><br><span class="line">    <span class="comment">//辅助数组</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span>[] dx = &#123;-<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span>[] dy = &#123;<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,-<span class="number">1</span>&#125;;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Game</span><span class="params">(Integer rows, Integer cols, Integer inner_walls_count)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.rows = rows;</span><br><span class="line">        <span class="built_in">this</span>.cols = cols;</span><br><span class="line">        <span class="built_in">this</span>.inner_walls_count = inner_walls_count;</span><br><span class="line">        <span class="built_in">this</span>.g = <span class="keyword">new</span> <span class="title class_">int</span>[rows][cols];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span>[][] getG() &#123;<span class="comment">//返回地图</span></span><br><span class="line">        <span class="keyword">return</span> g;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">check_connectivity</span><span class="params">(<span class="type">int</span> sx, <span class="type">int</span> sy,<span class="type">int</span> tx, <span class="type">int</span> ty)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sx == tx &amp;&amp; sy == ty)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        g[sx][sy] = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)&#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> sx + dx[i];</span><br><span class="line">            <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> sy + dy[i];</span><br><span class="line">            <span class="keyword">if</span>(x &gt;= <span class="number">0</span> &amp;&amp; x &lt; <span class="built_in">this</span>.rows &amp;&amp; y &gt;= <span class="number">0</span> &amp;&amp; y &lt; <span class="built_in">this</span>.cols &amp;&amp; g[x][y] == <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(check_connectivity(x, y, tx, ty))&#123;</span><br><span class="line">                    g[sx][sy] = <span class="number">0</span>;<span class="comment">//恢复现场</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        g[sx][sy] = <span class="number">0</span>;<span class="comment">//恢复现场</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">draw</span><span class="params">()</span>&#123;<span class="comment">//绘制地图</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.rows; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="built_in">this</span>.cols; j++) &#123;</span><br><span class="line">                g[i][j] = <span class="number">0</span>;<span class="comment">//0表示可通行区域 1表示障碍物</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//给四周加上障碍物</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> <span class="number">0</span>; r &lt; <span class="built_in">this</span>.rows; r++)&#123;<span class="comment">//给左右两侧设置为1</span></span><br><span class="line">            g[r][<span class="number">0</span>]=<span class="number">1</span>;</span><br><span class="line">            g[r][<span class="built_in">this</span>.cols-<span class="number">1</span>]=<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> <span class="number">0</span>; c &lt; <span class="built_in">this</span>.cols; c++)&#123;<span class="comment">//给上下两侧设置为1</span></span><br><span class="line">            g[<span class="number">0</span>][c] = g[<span class="built_in">this</span>.rows-<span class="number">1</span>][c] = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//在内部随机生成inner_walls_count个对称的障碍物</span></span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.inner_walls_count / <span class="number">2</span>; i++)&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">1000</span>; j++) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> random.nextInt(<span class="built_in">this</span>.rows);<span class="comment">//返回0~rows-1的随机值</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> random.nextInt(<span class="built_in">this</span>.cols);<span class="comment">//返回0~cols-1的随机值</span></span><br><span class="line">                <span class="keyword">if</span>(g[r][c] == <span class="number">1</span> || g[<span class="built_in">this</span>.rows - <span class="number">1</span> - r][<span class="built_in">this</span>.cols - <span class="number">1</span> - c] == <span class="number">1</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;<span class="comment">//已经有了 不能重复添加 直接进入下一轮循环 j++</span></span><br><span class="line">                <span class="keyword">if</span>(r == <span class="built_in">this</span>.rows - <span class="number">2</span> &amp;&amp; c == <span class="number">1</span> || r == <span class="number">1</span> &amp;&amp; c == <span class="built_in">this</span>.cols-<span class="number">2</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;<span class="comment">//保证左上角和右下角不能有障碍物</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//成功设置一个障碍物后 直接退出当前for i++</span></span><br><span class="line">                g[r][c] = g[<span class="built_in">this</span>.rows - <span class="number">1</span> - r][<span class="built_in">this</span>.cols - <span class="number">1</span> - c] = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//判断连通性</span></span><br><span class="line">        <span class="keyword">return</span> check_connectivity(<span class="built_in">this</span>.rows-<span class="number">2</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="built_in">this</span>.cols-<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createMap</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(draw())</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在<code>WebSocketServer.java</code></p>
<p>当开始匹配的时候，实例化一个 Game 对象用于生成地图，并将生成的地图返回给连接中的两个用户。</p>
<blockquote>
<p>当然，最终的地图应该是保存在 webSocket 中，也就是只对当前匹配的两个用户可见，对其他连接的用户不可见，这一点放在后面实现。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startMatching</span><span class="params">()</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;start matching!&quot;</span>);</span><br><span class="line">    matchpool.add(<span class="built_in">this</span>.user);</span><br><span class="line">    <span class="keyword">while</span> (matchpool.size() &gt;= <span class="number">2</span>)&#123;</span><br><span class="line">        Iterator&lt;User&gt; iterator = matchpool.iterator();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user2</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">        matchpool.remove(user1);</span><br><span class="line">        matchpool.remove(user2);</span><br><span class="line">        <span class="type">Game</span> <span class="variable">game</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Game</span>(<span class="number">13</span>,<span class="number">14</span>,<span class="number">20</span>);</span><br><span class="line">        game.createMap();</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">resp1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        resp1.put(<span class="string">&quot;event&quot;</span>,<span class="string">&quot;start-matching&quot;</span>);</span><br><span class="line">        resp1.put(<span class="string">&quot;opponent_username&quot;</span>,user2.getUsername());</span><br><span class="line">        resp1.put(<span class="string">&quot;opponent_photo&quot;</span>,user2.getPhoto());</span><br><span class="line">        resp1.put(<span class="string">&quot;gamemap&quot;</span>,game.getG());</span><br><span class="line">        <span class="type">WebSocketServer</span> <span class="variable">webSocketServer1</span> <span class="operator">=</span> userConnectionInfo.get(user1.getId());</span><br><span class="line">        webSocketServer1.sendMessage(resp1.toJSONString());</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">resp2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        resp2.put(<span class="string">&quot;event&quot;</span>,<span class="string">&quot;start-matching&quot;</span>);</span><br><span class="line">        resp2.put(<span class="string">&quot;opponent_username&quot;</span>,user1.getUsername());</span><br><span class="line">        resp2.put(<span class="string">&quot;opponent_photo&quot;</span>,user1.getPhoto());</span><br><span class="line">        resp2.put(<span class="string">&quot;gamemap&quot;</span>,game.getG());</span><br><span class="line">        <span class="type">WebSocketServer</span> <span class="variable">webSocketServer2</span> <span class="operator">=</span> userConnectionInfo.get(user2.getId());</span><br><span class="line">        webSocketServer2.sendMessage(resp2.toJSONString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时后端可以返回地图，前端写好接收地图的逻辑</p>
<p><code>src\store\pk.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">state</span>: &#123;</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&quot;matching&quot;</span>, <span class="comment">//matching表示匹配界面 playing表示对战界面</span></span><br><span class="line">    <span class="attr">socket</span>: <span class="literal">null</span>, <span class="comment">//存储前后端建立的connection</span></span><br><span class="line">    <span class="attr">opponent_username</span>: <span class="string">&quot;&quot;</span>, <span class="comment">//对手名</span></span><br><span class="line">    <span class="attr">opponent_photo</span>: <span class="string">&quot;&quot;</span>, <span class="comment">//对手头像</span></span><br><span class="line">    <span class="attr">gamemap</span>: <span class="literal">null</span>, <span class="comment">//地图</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">mutations</span>: &#123;</span><br><span class="line">    <span class="title function_">updateSocket</span>(<span class="params">state, socket</span>) &#123;</span><br><span class="line">      state.<span class="property">socket</span> = socket;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">updateOpponent</span>(<span class="params">state, opponent</span>) &#123;</span><br><span class="line">      state.<span class="property">opponent_username</span> = opponent.<span class="property">username</span>;</span><br><span class="line">      state.<span class="property">opponent_photo</span> = opponent.<span class="property">photo</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">updateStatus</span>(<span class="params">state, status</span>) &#123;</span><br><span class="line">      state.<span class="property">status</span> = status;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">updayeGamemap</span>(<span class="params">state, gamemap</span>) &#123;</span><br><span class="line">      state.<span class="property">gamemap</span> = gamemap;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">actions</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">modules</span>: &#123;&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>src\views\pk\PkIndexView.vue</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">socket.<span class="property">onmessage</span> = <span class="function">(<span class="params">msg</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(msg.<span class="property">data</span>);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">  <span class="keyword">if</span> (data.<span class="property">event</span> === <span class="string">&quot;start-matching&quot;</span>) &#123;</span><br><span class="line">    store.<span class="title function_">commit</span>(<span class="string">&quot;updateOpponent&quot;</span>, &#123;</span><br><span class="line">      <span class="attr">username</span>: data.<span class="property">opponent_username</span>,</span><br><span class="line">      <span class="attr">photo</span>: data.<span class="property">opponent_photo</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//匹配成功后，延时2秒，进入对战页面</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      store.<span class="title function_">commit</span>(<span class="string">&quot;updateStatus&quot;</span>, <span class="string">&quot;playing&quot;</span>);</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">    store.<span class="title function_">commit</span>(<span class="string">&quot;updateGamemap&quot;</span>, data.<span class="property">gamemap</span>); <span class="comment">//更新地图</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>后端获取<code>gamemap</code>并更新到全局变量之后，要将获取到的<code>gamemap</code>渲染到画布上</p>
<p>首先在组件<code>GameMap.vue</code>中将全局变量<code>store</code>传递到<code>GameMap</code>的构造函数中</p>
<p><code>src\components\GameMap.vue</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">import &#123; GameMap &#125; from &quot;../assets/scripts/GameMap&quot;;</span><br><span class="line">import &#123; onMounted, ref &#125; from &quot;vue&quot;; //用于定义变量</span><br><span class="line">import &#123; useStore &#125; from &quot;vuex&quot;;</span><br><span class="line">export default &#123;</span><br><span class="line">  setup() &#123;</span><br><span class="line">    const store = useStore();</span><br><span class="line">    let parent = ref(null);</span><br><span class="line">    let canvas = ref(null);</span><br><span class="line">    onMounted(() =&gt; &#123;</span><br><span class="line">      new GameMap(canvas.value.getContext(&quot;2d&quot;), parent.value, store);</span><br><span class="line">    &#125;);</span><br><span class="line">    return &#123;</span><br><span class="line">      parent,</span><br><span class="line">      canvas,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>对于<code>scripts\GameMap.js</code></p>
<p>相关的代码更新为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">GameMap</span> <span class="keyword">extends</span> <span class="title class_ inherited__">GameObject</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">ctx, parent, store</span>)&#123;</span><br><span class="line">        <span class="variable language_">super</span>();</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span> = ctx;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">parent</span> = parent;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">store</span> = store;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">L</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">rows</span> = <span class="number">13</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cols</span> = <span class="number">14</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">inner_walls_count</span> = <span class="number">10</span>;<span class="comment">//定义内部障碍物数量</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">walls</span> = [];<span class="comment">//用于保存障碍物,属于对象数组</span></span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">snakes</span> = [</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Snake</span>(&#123;<span class="attr">id</span>:<span class="number">0</span>, <span class="attr">color</span>:<span class="string">&quot;#4876EC&quot;</span>,<span class="attr">r</span>: <span class="variable language_">this</span>.<span class="property">rows</span> - <span class="number">2</span>, <span class="attr">c</span>: <span class="number">1</span>&#125;,<span class="variable language_">this</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Snake</span>(&#123;<span class="attr">id</span>:<span class="number">1</span>, <span class="attr">color</span>:<span class="string">&quot;#F94848&quot;</span>,<span class="attr">r</span>: <span class="number">1</span>, <span class="attr">c</span>: <span class="variable language_">this</span>.<span class="property">cols</span> - <span class="number">2</span>&#125;,<span class="variable language_">this</span>),</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//画地图:创建障碍物</span></span><br><span class="line">    <span class="title function_">create_walls</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">//直接将地图取出--后端传过来</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">store</span>)</span><br><span class="line">        <span class="keyword">const</span> g = <span class="variable language_">this</span>.<span class="property">store</span>.<span class="property">state</span>.<span class="property">pk</span>.<span class="property">gamemap</span>;</span><br><span class="line">        <span class="comment">//创建障碍物对象 并添加到this.walls数组</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> r = <span class="number">0</span>; r &lt; <span class="variable language_">this</span>.<span class="property">rows</span>; r++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">let</span> c = <span class="number">0</span>; c &lt; <span class="variable language_">this</span>.<span class="property">cols</span>; c++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(g[r][c])&#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">walls</span>.<span class="title function_">push</span>(<span class="keyword">new</span> <span class="title class_">Wall</span> (r,c,<span class="variable language_">this</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">start</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">create_walls</span>();<span class="comment">//不用循环1000次了 因为直接接收的后端生成的</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">add_listening_events</span>();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>至此，就解决了地图同步问题</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_cc256e645b-image-20220817162739007.png" alt="image-20220817162739007.png"></p>
<h2 id="玩家位置同步"><a href="#玩家位置同步" class="headerlink" title="玩家位置同步"></a>玩家位置同步</h2><h3 id="后端修改"><a href="#后端修改" class="headerlink" title="后端修改"></a>后端修改</h3><p>玩家的位置也要在服务端确定，确定完之后将每个玩家的位置传到前端。</p>
<p>添加一个玩家类</p>
<p><code>consumer.utils.Game.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Player</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> Integer sx;<span class="comment">//起始x坐标</span></span><br><span class="line">    <span class="keyword">private</span> Integer sy;<span class="comment">//起始y坐标</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Integer&gt; steps;<span class="comment">//保存每一步操作---决定了蛇当前的形状</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在初始化<code>Game</code>的时候，实例化两个<code>Player</code>对象</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_d97c81b95b-image-20220817175347817.png" alt="image-20220817175347817.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_ee2641215b-image-20220817175807564.png" alt="image-20220817175807564.png"></p>
<p>在<code>WebSocketServer.java</code>中，为了方便管理，将与<code>Game</code>相关的信息，封装成一个<code>JSON</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_fd21f64c5b-image-20220817181541093.png" alt="image-20220817181541093.png"></p>
<p>这样后端就可以将两名玩家的信息（包括生成的地图）传送给前端</p>
<h3 id="前端修改"><a href="#前端修改" class="headerlink" title="前端修改"></a>前端修改</h3><p>在<code>src\store\pk.js</code>中添加玩家信息的变量和更新函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">state</span>: &#123;</span><br><span class="line">    <span class="attr">status</span>: <span class="string">&quot;matching&quot;</span>, <span class="comment">//matching表示匹配界面 playing表示对战界面</span></span><br><span class="line">    <span class="attr">socket</span>: <span class="literal">null</span>, <span class="comment">//存储前后端建立的connection</span></span><br><span class="line">    <span class="attr">opponent_username</span>: <span class="string">&quot;&quot;</span>, <span class="comment">//对手名</span></span><br><span class="line">    <span class="attr">opponent_photo</span>: <span class="string">&quot;&quot;</span>, <span class="comment">//对手头像</span></span><br><span class="line">    <span class="attr">gamemap</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">a_id</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">a_sx</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">a_sy</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">b_id</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">b_sx</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">b_sy</span>: <span class="number">0</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">mutations</span>: &#123;</span><br><span class="line">    <span class="title function_">updateSocket</span>(<span class="params">state, socket</span>) &#123;</span><br><span class="line">      state.<span class="property">socket</span> = socket;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">updateOpponent</span>(<span class="params">state, opponent</span>) &#123;</span><br><span class="line">      state.<span class="property">opponent_username</span> = opponent.<span class="property">username</span>;</span><br><span class="line">      state.<span class="property">opponent_photo</span> = opponent.<span class="property">photo</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">updateStatus</span>(<span class="params">state, status</span>) &#123;</span><br><span class="line">      state.<span class="property">status</span> = status;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">updateGame</span>(<span class="params">state, game</span>) &#123;</span><br><span class="line">      state.<span class="property">a_id</span> = game.<span class="property">a_id</span>;</span><br><span class="line">      state.<span class="property">a_sx</span> = game.<span class="property">a_sx</span>;</span><br><span class="line">      state.<span class="property">a_sy</span> = game.<span class="property">a_sy</span>;</span><br><span class="line">      state.<span class="property">b_id</span> = game.<span class="property">b_id</span>;</span><br><span class="line">      state.<span class="property">b_sx</span> = game.<span class="property">b_sx</span>;</span><br><span class="line">      state.<span class="property">b_sy</span> = game.<span class="property">b_sy</span>;</span><br><span class="line">      state.<span class="property">gamemap</span> = game.<span class="property">map</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">actions</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">modules</span>: &#123;&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在<code>src\views\pk\PkIndexView.vue</code>中，在<code>onmessage</code>中，调用<code>updateGame</code>函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">import PlayGround from &#x27;../../components/PlayGround.vue&#x27;</span><br><span class="line">import MatchGround from &#x27;../../components/MatchGround.vue&#x27;</span><br><span class="line">import &#123; onMounted &#125; from &#x27;vue&#x27;</span><br><span class="line">import &#123; onUnmounted &#125; from &#x27;vue&#x27;</span><br><span class="line">import &#123; useStore &#125; from &#x27;vuex&#x27;</span><br><span class="line">export default &#123;</span><br><span class="line">    components: &#123;</span><br><span class="line">        PlayGround,</span><br><span class="line">        MatchGround</span><br><span class="line">    &#125;,</span><br><span class="line">    setup() &#123;</span><br><span class="line">        const store = useStore();</span><br><span class="line">        const socketUrl = `ws://127.0.0.1:3000/websocket/$&#123;store.state.user.token&#125;`;</span><br><span class="line">        let socket = null;</span><br><span class="line">        onMounted(() =&gt; &#123;</span><br><span class="line">            ....//省略</span><br><span class="line">            socket.onmessage = msg =&gt; &#123;</span><br><span class="line">                const data = JSON.parse(msg.data);</span><br><span class="line">                console.log(data);</span><br><span class="line">                if (data.event === &quot;start-matching&quot;) &#123;</span><br><span class="line">                    store.commit(&quot;updateOpponent&quot;, &#123;</span><br><span class="line">                        username: data.opponent_username,</span><br><span class="line">                        photo: data.opponent_photo</span><br><span class="line">                    &#125;);</span><br><span class="line">                    //匹配成功后，延时2秒，进入对战页面</span><br><span class="line">                    setTimeout(() =&gt; &#123;</span><br><span class="line">                        store.commit(&quot;updateStatus&quot;, &quot;playing&quot;)</span><br><span class="line">                    &#125;, 2000);</span><br><span class="line">                    store.commit(&quot;updateGame&quot;,data.game)//更新Game:包括玩家信息和地图</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            socket.onclose = () =&gt; &#123;</span><br><span class="line">                console.log(&quot;disconnected!&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        onUnmounted(() =&gt; &#123;</span><br><span class="line">            socket.close();</span><br><span class="line">            store.commit(&quot;updateStatus&quot;, &quot;matching&quot;);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>运行项目，使用用户名 sun 和用户名 hong 的登录，两个浏览器控制台<code>console.log(data.game)</code>的输出内容一致，均为，同步成功</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_0fd4df785b-image-20220817184701914.png" alt="image-20220817184701914.png"></p>
<h2 id="游戏同步：多线程"><a href="#游戏同步：多线程" class="headerlink" title="游戏同步：多线程"></a>游戏同步：多线程</h2><h3 id="分析过程"><a href="#分析过程" class="headerlink" title="分析过程"></a>分析过程</h3><p>之前只是两个棋盘，在浏览器本地通过 wsad 和上下左右来控制移动。</p>
<p>现在三个棋盘，两个 client 和一个 server，需要实现三个棋盘的同步</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_1df336605b-image-20220818094655746.png" alt="image-20220818094655746.png"></p>
<p>再来梳理一下之前的游戏流程</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_2cc9647a5b-image-20220818095616805.png" alt="image-20220818095616805.png"></p>
<p>对于从等待用户 orBot 输入到判别系统这一过程是独立的，</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_45f5a38d5b-image-20220818095749236.png" alt="image-20220818095749236.png"></p>
<p>但是一般代码的执行是单线程，也就是按照顺序执行，例如如果在当前线程执行操作，当等待用户输入的时候，线程就会卡死，需要我们这样一个线程中有多个游戏在运行，只有 Game1 结束之后才能跑 Game2，这样在第二个对局中，玩家就会漫长的等待。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_597ad4cb5b-image-20220818100333814.png" alt="image-20220818100333814.png"></p>
<p>因此，Game 不能作为一个单线程来处理，因此，需要另起一个新的线程来做。</p>
<p>也就是将 Game 变成一个支持多线程的类</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_6a6afda05b-image-20220818100750453.png" alt="image-20220818100750453.png"></p>
<h3 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h3><p>首先为<code>WebSocketServer</code>增加一个成员变量，用于记录链接中的 Game 实例</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_7611d1875b-image-20220818101937329.png" alt="image-20220818101937329.png"></p>
<p>在确定两名匹配的玩家之后，更新两名玩家的<code>WebSocketServer</code>连接上的<code>Game</code>实例值。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_83dc89375b-image-20220818102328316.png" alt="image-20220818102328316.png"></p>
<p>然后回到<code>Game.java</code>，将<code>Game</code>变成一个支持多线程的类，只需将<code>Game</code>继承<code>Thread</code>类，就可以支持多线程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Game</span> <span class="keyword">extends</span> <span class="title class_">Thread</span></span><br></pre></td></tr></table></figure>
<p>然后重写多线程的入口函数<code>run()</code></p>
<p>在开启一个新线程执行<code>game.start()</code>的时候，新线程中的入口函数，就是<code>run()</code></p>
<p>初始化两个成员变量，用于表示两名玩家的下一步操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Integer nextStepA;</span><br><span class="line"><span class="keyword">private</span> Integer nextStepB;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNextStepA</span><span class="params">(Integer nextStepA)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.nextStepA = nextStepA;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNextStepB</span><span class="params">(Integer nextStepB)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.nextStepB = nextStepB;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>未来会在<code>WebSocketServer.java</code>中，接收到输入的时候，调用这两个函数</p>
<p>也就是在蓝色的线程里面修改<code>nextStepA</code>和<code>nextStepB</code>的值，而在红色的线程里面，会读取这两个线程的值</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_93caf0e45b-image-20220818103052021.png" alt="image-20220818103052021.png"></p>
<p>这就涉及到两个线程会同时读写一个变量，可能会产生读写冲突，需要枷锁</p>
<p>定义一个锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br></pre></td></tr></table></figure>
<p>之后在<code>setNextStepA</code>和<code>setNextStepB</code>中</p>
<p>对两个变量进行更新之前，先锁上，操作完之后，解锁（不管有没有报异常）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNextStepA</span><span class="params">(Integer nextStepA)</span> &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.nextStepA = nextStepA;</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNextStepB</span><span class="params">(Integer nextStepB)</span> &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.nextStepB = nextStepB;</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>nextStep()</code>函数中，负责等待两名玩家的输入，如果都在指定时间内输入了，就返回<code>true</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">nextStep</span><span class="params">()</span>&#123;<span class="comment">//等待两名玩家的下一步操作</span></span><br><span class="line">    <span class="comment">//由于前端动画200ms才能画一个格子</span></span><br><span class="line">    <span class="comment">//如果在此期间接收到的输入多于一步 只会留最后一步 多余的会被覆盖</span></span><br><span class="line">    <span class="comment">//因此在每一个下一步都要先休息200ms</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">200</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果5秒内有玩家没有输入 就返回false</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(nextStepA != <span class="literal">null</span> &amp;&amp; nextStepB != <span class="literal">null</span>)&#123;</span><br><span class="line">                    playerA.getSteps().add(nextStepA);</span><br><span class="line">                    playerB.getSteps().add(nextStepB);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果其中一个超时没有输入，游戏就终止，并且分出胜负。</p>
<p>因此还需要定义一个游戏状态<code>status</code>和谁输了<code>loser</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">String</span> <span class="variable">status</span> <span class="operator">=</span> <span class="string">&quot;playing&quot;</span>;<span class="comment">//游戏状态 playing--&gt;finished</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> <span class="variable">loser</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;<span class="comment">//all:平; A:A输; B:B输了</span></span><br></pre></td></tr></table></figure>
<p>最后，在线程的入口<code>run()</code>中初始逻辑如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;<span class="comment">//1000步之内游戏肯定结束</span></span><br><span class="line">        <span class="keyword">if</span>(nextStep())&#123;</span><br><span class="line">            <span class="comment">//如果获取两个玩家的下一步操作</span></span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            status = <span class="string">&quot;finished&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span>(nextStepA == <span class="literal">null</span> &amp;&amp; nextStepB == <span class="literal">null</span>)&#123;</span><br><span class="line">                loser = <span class="string">&quot;all&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nextStepA == <span class="literal">null</span>) &#123;</span><br><span class="line">                loser = <span class="string">&quot;A&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">                loser = <span class="string">&quot;B&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是上面这段逻辑有个问题，如果两名玩家在五秒内没有给出操作，就会进入<code>else</code>判断，此时本应该是平均，也就是<code>loser = &quot;all&quot;</code>，但如果下面这段代码执行时，用户给出了输入，结果就会不符合预期。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(nextStepA == <span class="literal">null</span> &amp;&amp; nextStepB == <span class="literal">null</span>)&#123;</span><br><span class="line">       loser = <span class="string">&quot;all&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (nextStepA == <span class="literal">null</span>) &#123;</span><br><span class="line">       loser = <span class="string">&quot;A&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span>&#123;</span><br><span class="line">       loser = <span class="string">&quot;B&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以，由于这里涉及到变量的读操作，为了在读的过程中被修改，因此也需要加锁。读完之后再解锁。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(nextStep())&#123;</span><br><span class="line">    <span class="comment">//如果获取两个玩家的下一步操作</span></span><br><span class="line">    System.out.println();</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    status = <span class="string">&quot;finished&quot;</span>;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(nextStepA == <span class="literal">null</span> &amp;&amp; nextStepB == <span class="literal">null</span>)&#123;</span><br><span class="line">            loser = <span class="string">&quot;all&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nextStepA == <span class="literal">null</span>) &#123;</span><br><span class="line">            loser = <span class="string">&quot;A&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">            loser = <span class="string">&quot;B&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后来看<code>if (nextStep())</code>判断，如果获取两个玩家的下一步操作</p>
<p>需要先进行<code>judge()</code>，来判断输入是否合法</p>
<p>并且，虽然 A 和 B 都知道自己的操作，但是看不到对方的操作，因此需要中心服务器以广播的形式来告知。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_a35e3d6a5b-image-20220818174229481.png" alt="image-20220818174229481.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;<span class="comment">//1000步之内游戏肯定结束</span></span><br><span class="line">        <span class="keyword">if</span> (nextStep()) &#123;</span><br><span class="line">            <span class="comment">//如果获取两个玩家的下一步操作</span></span><br><span class="line">            judge();</span><br><span class="line">            <span class="keyword">if</span>(status.equals(<span class="string">&quot;playing&quot;</span>))&#123;</span><br><span class="line">                sentMove();</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                sentResult();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            status = <span class="string">&quot;finished&quot;</span>;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (nextStepA == <span class="literal">null</span> &amp;&amp; nextStepB == <span class="literal">null</span>) &#123;</span><br><span class="line">                    loser = <span class="string">&quot;all&quot;</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nextStepA == <span class="literal">null</span>) &#123;</span><br><span class="line">                    loser = <span class="string">&quot;A&quot;</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    loser = <span class="string">&quot;B&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.lock();</span><br><span class="line">            &#125;</span><br><span class="line">            sentResult();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而其中暂时不实现<code>judge</code>的逻辑，其他辅助函数的逻辑如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sentAllmessage</span><span class="params">(String message)</span>&#123;<span class="comment">//工具函数:向两名玩家广播信息</span></span><br><span class="line">    WebSocketServer.userConnectionInfo.get(playerA.getId()).sendMessage(message);</span><br><span class="line">    WebSocketServer.userConnectionInfo.get(playerB.getId()).sendMessage(message);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sentMove</span><span class="params">()</span> &#123;<span class="comment">//向两个Client广播玩家操作信息</span></span><br><span class="line">    lock.lock();<span class="comment">//凡是对操作进行读写的操作 都要加锁</span></span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">resp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        resp.put(<span class="string">&quot;event&quot;</span>,<span class="string">&quot;move&quot;</span>);</span><br><span class="line">        resp.put(<span class="string">&quot;a_direction&quot;</span>,nextStepA);</span><br><span class="line">        resp.put(<span class="string">&quot;b_direction&quot;</span>,nextStepB);</span><br><span class="line">        nextStepA = nextStepB = <span class="literal">null</span>;<span class="comment">//清空操作</span></span><br><span class="line">        sentAllmessage(resp.toJSONString());</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sentResult</span><span class="params">()</span> &#123;<span class="comment">//向两个client公布结果信息</span></span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">resp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    resp.put(<span class="string">&quot;event&quot;</span>,<span class="string">&quot;result&quot;</span>);<span class="comment">//定义事件</span></span><br><span class="line">    resp.put(<span class="string">&quot;loser&quot;</span>,loser);</span><br><span class="line">    sentAllmessage(resp.toJSONString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样后端基本逻辑完成，接下来是前端与后端的通信，前端要将用户的操作发送过来，以及接收并处理中心服务器的广播</p>
<h3 id="前后端通信"><a href="#前后端通信" class="headerlink" title="前后端通信"></a>前后端通信</h3><p>此前判断蛇的移动，在<code>scripts\GameMap.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">add_listening_events</span>(<span class="params"></span>)&#123;</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">canvas</span>.<span class="title function_">focus</span>();<span class="comment">//聚焦</span></span><br><span class="line">       <span class="keyword">const</span> [snake0, snake1] = <span class="variable language_">this</span>.<span class="property">snakes</span>;</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">canvas</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;keydown&quot;</span>,<span class="function"><span class="params">e</span>=&gt;</span>&#123;</span><br><span class="line">           <span class="variable language_">console</span>.<span class="title function_">log</span>(e.<span class="property">key</span>);</span><br><span class="line">           <span class="comment">//wasd控制左下角球 上下左右控制右上角球</span></span><br><span class="line">           <span class="keyword">if</span>(e.<span class="property">key</span> === <span class="string">&#x27;w&#x27;</span>) snake0.<span class="title function_">set_direction</span>(<span class="number">0</span>);</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">&#x27;d&#x27;</span>) snake0.<span class="title function_">set_direction</span>(<span class="number">1</span>);</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">&#x27;s&#x27;</span>) snake0.<span class="title function_">set_direction</span>(<span class="number">2</span>);</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">&#x27;a&#x27;</span>) snake0.<span class="title function_">set_direction</span>(<span class="number">3</span>);</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">&#x27;ArrowUp&#x27;</span>) snake1.<span class="title function_">set_direction</span>(<span class="number">0</span>);</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">&#x27;ArrowRight&#x27;</span>) snake1.<span class="title function_">set_direction</span>(<span class="number">1</span>);</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">&#x27;ArrowDown&#x27;</span>) snake1.<span class="title function_">set_direction</span>(<span class="number">2</span>);</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">&#x27;ArrowLeft&#x27;</span>) snake1.<span class="title function_">set_direction</span>(<span class="number">3</span>);</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这里，由于一个 client 负责一个玩家，只处理 wsad 即可。</p>
<p>修改如下，将玩家的操作操作传送到后端</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">add_listening_events</span>(<span class="params"></span>)&#123;</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">canvas</span>.<span class="title function_">focus</span>();<span class="comment">//聚焦</span></span><br><span class="line">       <span class="keyword">const</span> [snake0, snake1] = <span class="variable language_">this</span>.<span class="property">snakes</span>;</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">canvas</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;keydown&quot;</span>,<span class="function"><span class="params">e</span>=&gt;</span>&#123;</span><br><span class="line">           <span class="variable language_">console</span>.<span class="title function_">log</span>(e.<span class="property">key</span>);</span><br><span class="line">           <span class="comment">//wasd控制移动</span></span><br><span class="line">           <span class="keyword">let</span> d = -<span class="number">1</span>;</span><br><span class="line">           <span class="keyword">if</span>(e.<span class="property">key</span> === <span class="string">&#x27;w&#x27;</span>) d = <span class="number">0</span>;</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">&#x27;d&#x27;</span>) d = <span class="number">1</span>;</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">&#x27;s&#x27;</span>) d = <span class="number">2</span>;</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">&#x27;a&#x27;</span>) d = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span>(d &gt;= <span class="number">0</span>)&#123;<span class="comment">//有效输入</span></span><br><span class="line">               <span class="variable language_">this</span>.<span class="property">store</span>.<span class="property">state</span>.<span class="property">pk</span>.<span class="property">socket</span>.<span class="title function_">sent</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;<span class="comment">//将JSON转换为字符串</span></span><br><span class="line">                   <span class="attr">event</span>:<span class="string">&quot;move&quot;</span>,</span><br><span class="line">                   <span class="attr">direction</span>:d,</span><br><span class="line">               &#125;))</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>后端接收并分配给专门的路由来进行处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">move</span><span class="params">(Integer direction)</span> &#123;</span><br><span class="line">    <span class="comment">//判断是A玩家还是B玩家在操作</span></span><br><span class="line">    <span class="keyword">if</span>(game.getPlayerA().getId().equals(user.getId()))&#123;</span><br><span class="line">        game.setNextStepA(direction);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (game.getPlayerB().getId().equals(user.getId())) &#123;</span><br><span class="line">        game.setNextStepB(direction);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">Exception</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">&quot;Error&quot;</span>);</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@OnMessage</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message, Session session)</span> &#123;<span class="comment">//当做路由 分配任务</span></span><br><span class="line">    <span class="comment">// Server从Client接收消息时触发</span></span><br><span class="line">    System.out.println(<span class="string">&quot;Receive message!&quot;</span>);</span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">data</span> <span class="operator">=</span> JSONObject.parseObject(message);<span class="comment">//将字符串解析成JSON</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">event</span> <span class="operator">=</span> data.getString(<span class="string">&quot;event&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&quot;start-matching&quot;</span>.equals(event))&#123;<span class="comment">//防止event为空的异常</span></span><br><span class="line">        startMatching();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;stop-matching&quot;</span>.equals(event)) &#123;</span><br><span class="line">        stopMatching();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;move&quot;</span>.equals(event)) &#123;</span><br><span class="line">       	<span class="type">Integer</span> <span class="variable">direction</span> <span class="operator">=</span> data.getInteger(<span class="string">&quot;direction&quot;</span>);</span><br><span class="line">        System.out.println(direction);</span><br><span class="line">        move(direction);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时，client 端用户输入 WSAD 的时候，后端就能准确接收到信息。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_bced30b45b-image-20220818183500945.png" alt="image-20220818183500945.png"></p>
<p>同时，前端也要接收后端的广播来的信息，具体有两种<code>event</code>，分别是<code>move</code>和<code>result</code></p>
<h3 id="1-event-move"><a href="#1-event-move" class="headerlink" title="1) event == move"></a>1) event == move</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_c5e3ce235b-image-20220818191839958.png" alt="image-20220818191839958.png"></p>
<p>对操作进行更新需要用到<code>Snack.js</code>中的<code>set_direction</code>方法</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_d1cce0275b-image-20220818192126187.png" alt="image-20220818192126187.png"></p>
<p>两个玩家控制的<code>snack</code>对象在保存在<code>GameMap</code>对象中。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_df63ab0a5b-image-20220818192357488.png" alt="image-20220818192357488.png"></p>
<p>为了取到，需要将<code>GameMap</code>对象，作为游戏对象，保存为全局变量</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_ed61be085b-image-20220818191356614.png" alt="image-20220818191356614.png"></p>
<p>先在<code>src\store\pk.js</code>中将<code>gameObject</code>存入全局变量，并写好更新函数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_15c5d7695b-image-20220818191647251.png" alt="image-20220818191647251.png"></p>
<p>这样就能获取到游戏对象，并且更新两个玩家控制的<code>snack</code>的方向</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_2184e4865b-image-20220818195452452.png" alt="image-20220818195452452.png"></p>
<p>此时，两个玩家都能够控制蛇正常移动</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_3b4a1f3d5b-image-20220818200929557.png" alt="image-20220818200929557.png"></p>
<p>但是每次输入之后都会感觉到一些延迟，是因为输入之后可能线程还处于睡眠状态</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_499fbc4a5b-image-20220818200727010.png" alt="image-20220818200727010.png"></p>
<p>调整为：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_59b43be15b-image-20220818200738389.png" alt="image-20220818200738389.png"></p>
<h3 id="2-event-result"><a href="#2-event-result" class="headerlink" title="2) event == result"></a>2) event == result</h3><p>之前判断玩家输赢（蛇的状态）的逻辑在前端</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//如果下一步操作撞了 蛇瞬间去世</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">gamemap</span>.<span class="title function_">check_valid</span>(<span class="variable language_">this</span>.<span class="property">next_cell</span>)) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">status</span> = <span class="string">&quot;die&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_6b7530ad5b-image-20220819103307108.png" alt="image-20220819103307108.png"></p>
<p>将这段代码去掉。现在要交由后端来播报结果。</p>
<p>判断输赢有两部分逻辑：撞墙和超时，超时的逻辑已经写好，现在写判断撞墙的逻辑</p>
<p>参考前端<code>GameMap.js</code>中的<code>check_valid(cell)</code>函数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_76ef62c15b-image-20220819104425612.png" alt="image-20220819104425612.png"></p>
<p>后端逻辑如下：</p>
<p>1）首先需要将两名玩家所控制的蛇取到：</p>
<p>新建<code>Cell</code>类代表蛇的单元</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Cell</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer x;</span><br><span class="line">    <span class="keyword">private</span> Integer y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>Player.java</code>中，将蛇的身体返回</p>
<p>0、1、2、3 位置表示表示上右下左</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_849d33df5b-image-20220819105814184.png" alt="image-20220819105814184.png"></p>
<p>对于四种操作<code>0(w), 1(d), 2(s), 3(a)</code>分别在行和列方向上的偏移量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>[] dx = &#123;-<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>&#125;;<span class="comment">//行方向的偏移量</span></span><br><span class="line"><span class="type">int</span>[] dy = &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>&#125;; <span class="comment">//列方向的偏移量</span></span><br></pre></td></tr></table></figure>
<p>所以<code>Player.java</code>的逻辑更新为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Player</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> Integer sx;<span class="comment">//起始x坐标</span></span><br><span class="line">    <span class="keyword">private</span> Integer sy;<span class="comment">//起始y坐标</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Integer&gt; steps;<span class="comment">//保存每一步操作---决定了蛇当前的形状</span></span><br><span class="line">    <span class="comment">//检验当前回合 蛇的长度是否增加</span></span><br><span class="line">    <span class="keyword">private</span>  <span class="type">boolean</span> <span class="title function_">check_tail_increasing</span><span class="params">(<span class="type">int</span> step)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(step &lt;= <span class="number">10</span>) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> step % <span class="number">3</span> == <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//返回蛇的身体</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Cell&gt; <span class="title function_">getCells</span><span class="params">()</span>&#123;</span><br><span class="line">        List&lt;Cell&gt; res = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//对于四种操作0(w), 1(d), 2(s), 3(a)</span></span><br><span class="line">        <span class="comment">// 在行和列方向上的计算偏移量</span></span><br><span class="line">        <span class="type">int</span>[] dx = &#123;-<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>&#125;;</span><br><span class="line">        <span class="type">int</span>[] dy = &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>&#125;;</span><br><span class="line">        <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> sx;</span><br><span class="line">        <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> sy;</span><br><span class="line">        <span class="type">int</span> <span class="variable">step</span> <span class="operator">=</span> <span class="number">0</span>;<span class="comment">//回合数</span></span><br><span class="line">        res.add(<span class="keyword">new</span> <span class="title class_">Cell</span>(x,y));<span class="comment">//添加起点</span></span><br><span class="line">        <span class="comment">//不断根据steps计算出整个蛇身体</span></span><br><span class="line">        <span class="keyword">for</span> (Integer d : steps) &#123;</span><br><span class="line">            x += dx[d];</span><br><span class="line">            y += dy[d];</span><br><span class="line">            res.add(<span class="keyword">new</span> <span class="title class_">Cell</span>(x,y));</span><br><span class="line">            <span class="keyword">if</span>(!check_tail_increasing(++step))&#123;</span><br><span class="line">                <span class="comment">//如果蛇尾不增加 就删掉蛇尾</span></span><br><span class="line">                res.remove(<span class="number">0</span>);<span class="comment">//O(N)</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2）判断两名玩家最后一步操作是否合法</p>
<ul>
<li>没有撞到障碍物</li>
<li>没有撞到两条蛇的身体<ul>
<li>没有撞到自己：最后一步与之前 n-1 个 Cell 是否重合</li>
<li>没有撞到别人：最后一步与之前 n-1 个 Cell 是否重合<ul>
<li>由于 A 和 B 不可能走到同一个格子 因此不用判断最后一个格子是否重合</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>只需要判断最后一步，也就是蛇的最后一个 Cell 是否符合上面三种原则即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">check_valid</span><span class="params">(List&lt;Cell&gt; cellsA, List&lt;Cell&gt; cellsB)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> cellsA.size();</span><br><span class="line">    <span class="type">Cell</span> <span class="variable">cell</span> <span class="operator">=</span> cellsA.get(n - <span class="number">1</span>);<span class="comment">//取到A的最后一步</span></span><br><span class="line">    <span class="comment">//三种不合法操作: A撞墙、A撞A、A撞B</span></span><br><span class="line">    <span class="comment">//A撞墙</span></span><br><span class="line">    <span class="keyword">if</span>(g[cell.getX()][cell.getY()] == <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//A撞A</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n - <span class="number">1</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(cellsA.get(i).getX().equals(cell.getX())</span><br><span class="line">                &amp;&amp; cellsA.get(i).getY().equals(cell.getY()))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//A撞B</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n - <span class="number">1</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(cellsB.get(i).getX().equals(cell.getX())</span><br><span class="line">                &amp;&amp; cellsB.get(i).getY().equals((cell.getY())))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">judge</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Cell&gt; cellsA = playerA.getCells();</span><br><span class="line">    List&lt;Cell&gt; cellsB = playerB.getCells();</span><br><span class="line">    <span class="comment">//判断两名玩家最后一步操作是否合法</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">validA</span> <span class="operator">=</span> check_valid(cellsA, cellsB);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">validB</span> <span class="operator">=</span> check_valid(cellsB, cellsA);</span><br><span class="line">    <span class="keyword">if</span>(!validA || !validB)&#123;</span><br><span class="line">        status = <span class="string">&quot;finished&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>(validA)&#123;</span><br><span class="line">            loser = <span class="string">&quot;B&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (validB) &#123;</span><br><span class="line">            loser = <span class="string">&quot;A&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            loser = <span class="string">&quot;all&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时就能正常的进行合法性判断。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_9390d3505b-image-20220819141014616.png" alt="image-20220819141014616.png"></p>
<h3 id="游戏结果展示"><a href="#游戏结果展示" class="headerlink" title="游戏结果展示"></a>游戏结果展示</h3><p>最后，还需要将游戏的结果在前端展示，并且，设置一个重启按钮，点击重启之后，重新开始一局。</p>
<p>在<code>pk.js</code>中新增变量，方便用于展示谁赢谁输</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_a0a5f5d55b-image-20220819150811233.png" alt="image-20220819150811233.png"></p>
<p>新增一个组件<code>ResultBoard.vue</code>用于展示结果</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_abb6f3a85b-image-20220819150653501.png" alt="image-20220819150653501.png"></p>
<p>核心代码如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_baf331395b-image-20220819152032707.png" alt="image-20220819152032707.png"></p>
<p>然后在对战页面<code>PkIndexView.vue</code>导入组件，使其在<code>loser!=none</code>时展示出来</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_c6ec9a0e5b-image-20220819151024672.png" alt="image-20220819151024672.png"></p>
<p>并且在收到后端播报结果时，更新全局变量中的 loser</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_d26014ba5b-image-20220819151121848.png" alt="image-20220819151121848.png"></p>
<p>最终的结果如下，成功的实现了结果展示和重来一局。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_dd6a39da5b-image-20220819150244338.png" alt="image-20220819150244338.png"></p>
<p>点击重启</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_05598a0e5b-image-20220819151913696.png" alt="image-20220819151913696.png"></p>
<p>此时，再匹配的用户，又可以开始新的一轮对战。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_efff7d915b-image-20220819150538480.png" alt="image-20220819150538480.png"></p>
<p>这样，游戏同步功能就全部完成。</p>
<h2 id="对局记录"><a href="#对局记录" class="headerlink" title="对局记录"></a>对局记录</h2><p>接下来来实现另外一功能，就是将对局记录保存在数据库中。</p>
<h3 id="创建-record"><a href="#创建-record" class="headerlink" title="创建 record"></a>创建 record</h3><p>1）创建<code>record</code>表用来记录每局对战的信息</p>
<p>表中的列：</p>
<ul>
<li><code>id: int</code><ul>
<li>非空 自增 唯一 主键</li>
</ul>
</li>
<li><code>a_id: int</code></li>
<li><code>a_sx: int</code></li>
<li><code>a_sy: int</code></li>
<li><code>b_id: int</code></li>
<li><code>b_sx: int</code></li>
<li><code>b_sy: int</code></li>
<li><code>a_steps: varchar(1000)</code></li>
<li><code>b_steps: varchar(1000)</code></li>
<li><code>map: varchar(1000)</code></li>
<li><code>loser: varchar(10)</code></li>
<li><code>createtime: datetime</code></li>
</ul>
<p>2）创建 Pojo</p>
<p>注意，数据库中如果用下划线，则在 pojo 中要使用驼峰命名法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Record</span> &#123;</span><br><span class="line">    <span class="meta">@TableId(type = IdType.AUTO)</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> Integer aId;</span><br><span class="line">    <span class="keyword">private</span> Integer aSx;</span><br><span class="line">    <span class="keyword">private</span> Integer aSy;</span><br><span class="line">    <span class="keyword">private</span> Integer bId;</span><br><span class="line">    <span class="keyword">private</span> Integer bSx;</span><br><span class="line">    <span class="keyword">private</span> Integer bSy;</span><br><span class="line">    <span class="keyword">private</span> String aSteps;</span><br><span class="line">    <span class="keyword">private</span> String bSteps;</span><br><span class="line">    <span class="keyword">private</span> String map;</span><br><span class="line">    <span class="keyword">private</span> String loser;</span><br><span class="line">    <span class="meta">@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;, timezone = &quot;Asia/Shanghai&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Date createtime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3）创建 Mapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RecordMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;Record&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="写入数据库"><a href="#写入数据库" class="headerlink" title="写入数据库"></a>写入数据库</h3><p>首先将<code>RecordMapper</code>实例注入到<code>WebSocketServer</code>中</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_1580d0ce5b-image-20220819153955853.png" alt="image-20220819153955853.png"></p>
<p>在<code>Game.java</code>中，在每次向<code>client</code>播报结果之前，将记录保存到数据库</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_2174436c5b-image-20220819161328576.png" alt="image-20220819161328576.png"></p>
<p>这样在每局游戏结束时，记录就被保存下来</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_30dfdc5a5b-image-20220819161136837.png" alt="image-20220819161136837.png"></p>
<p>后续就可以根据记录来复原游戏画面</p>
<h2 id="实现匹配系统的微服务"><a href="#实现匹配系统的微服务" class="headerlink" title="实现匹配系统的微服务"></a>实现匹配系统的微服务</h2><p>微服务可以理解为在 SpringBoot 之外的另外一个 Server，负责处理一段独立的功能，与 SpringBoot Server 之间通过 http 通信。在游戏的匹配系统，之前是简单粗暴的放在一个集合上，当集合元素大于 2 时，取出两名玩家进行匹配，无法适应更加复杂的场景，因此现在要将这段程序独立出来。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_3ea08e0c5b-image-20220819163919485.png" alt="image-20220819163919485.png"></p>
<p>微服务有多种实现方式，这里采用 SpringCloud。SpringCloud 和 SpringBoot 都相当于一个 Web Server 两者之间通过 Http 通信</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_4b1ddceb5b-image-20220819164220414.png" alt="image-20220819164220414.png"></p>
<p>由于 SpringCloud 实现的匹配系统和 SpringBoot 实现的游戏后端是并列的，因此项目结构需要改动。</p>
<h3 id="创建SpringCloud项目"><a href="#创建SpringCloud项目" class="headerlink" title="创建SpringCloud项目"></a>创建<code>SpringCloud</code>项目</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_59695abb5b-image-20220819164536854.png" alt="image-20220819164536854.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_66096c775b-image-20220819164609646.png" alt="image-20220819164609646.png"></p>
<h3 id="配置SpringCloud项目"><a href="#配置SpringCloud项目" class="headerlink" title="配置SpringCloud项目"></a>配置<code>SpringCloud</code>项目</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_760a0a825b-image-20220819164950301.png" alt="image-20220819164950301.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_87cfce3b5b-image-20220819165048025.png" alt="image-20220819165048025.png"></p>
<p>在<code>SpringCloud</code>项目中添加依赖：<br><a target="_blank" rel="noopener" href="https://mvnrepository.com/">Maven 仓库地址</a><br><code>spring-cloud-dependencies</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_965b6d7f5b-image-20220819165333956.png" alt="image-20220819165333956.png"></p>
<h3 id="添加子项目—MatchingSystem"><a href="#添加子项目—MatchingSystem" class="headerlink" title="添加子项目—MatchingSystem"></a>添加子项目—MatchingSystem</h3><h4 id="1）添加和配置"><a href="#1）添加和配置" class="headerlink" title="1）添加和配置"></a>1）添加和配置</h4><p>创建<code>SpringCloud</code>的子项目——<code>matchingsystem</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_a51705425b-image-20220819165439541.png" alt="image-20220819165439541.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_b493160d5b-image-20220819165620115.png" alt="image-20220819165620115.png"></p>
<p>然后需要配置一些依赖。</p>
<p><code>matchingsystem</code>本质上也是一个<code>springboot</code>，所以需要将父级目录<code>backendcloud</code>中<code>porm.xml</code>中的依赖，<code>SpringWeb</code>依赖，直接复制到子项目<code>matchingsystem</code>对应的<code>porm.xml</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_c094473e5b-image-20220819170225988.png" alt="image-20220819170225988.png"></p>
<p>创建<code>application.properties</code>，配置端口，由于游戏后端<code>backend</code>中是 3000，这里设置为 3001</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_e17fd6645b-image-20220819170743739.png" alt="image-20220819170743739.png"></p>
<h4 id="2）匹配系统的简单布局"><a href="#2）匹配系统的简单布局" class="headerlink" title="2）匹配系统的简单布局"></a>2）匹配系统的简单布局</h4><p>对于匹配系统而言，需要实现的接口中需要有两个函数，<code>addPlayer</code>和<code>removePlayer</code>用于添加和删除玩家</p>
<p>创建接口，就需要创建<code>controller</code>负责调用接口，<code>service</code>负责声明接口，<code>service.impl</code>负责实现接口</p>
<p>为了方便调试，暂时不实现具体功能。</p>
<p><code>MatchingService.java</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_f16856375b-image-20220819174150845.png" alt="image-20220819174150845.png"></p>
<p><code>MatchingServiceImpl.java</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_0a8be3605b-image-20220819230327095.png" alt="image-20220819230327095.png"></p>
<p><code>MatchingController.java</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_27aa6a335b-image-20220819174309856.png" alt="image-20220819174309856.png"></p>
<p>注意，对于<code>MultiValueMap</code>结构而言，运行一个<code>key</code>对应的多个<code>value</code>，并用数组保存</p>
<p><code>map.getFirst(&quot;user_id&quot;)</code>表示<code>user_id</code>所对应的<code>value</code>数组中，第一个值 001</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_4d369b505b-image-20220819173518541.png" alt="image-20220819173518541.png"></p>
<p>此时<code>MatchingController</code>还有一个问题是，没有授权验证，这样就有外网通过其他请求来恶意攻击的风险。</p>
<p>与之前<code>backend</code>一样，添加<code>Spring Security</code>依赖</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_777fd6d55b-image-20220819174800486.png" alt="image-20220819174800486.png"></p>
<p>照着之前的代码，只用到<code>configure</code>这一段代码，且不涉及<code>Jwt-token</code>的验证，直接抄过来修改</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_8021d3635b-image-20220819175735806.png" alt="image-20220819175735806.png"></p>
<p>我们期望的的是只能被后端服务器访问，而不能以其他方式访问。解决这个问题，可以根据 IP 地址来判断，也就是只能通过本地，而不能通过其他地方来访问。</p>
<p>如下图，对<code>&quot;/player/add/&quot;</code>和<code>&quot;/player/remove/&quot;</code>的请求放开</p>
<p>只有 IP 地址为本地（127.0.0.1）的<code>Server</code>发出的请求才是有效的。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_89ca5e985b-image-20220819194957707.png" alt="image-20220819194957707.png"></p>
<p>将原来的<code>Main</code>函数，重命名为<code>MatchingSystemApplication</code>，作为<code>Springboot</code>的入口</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_a3108dd45b-image-20220819180722912.png" alt="image-20220819180722912.png"></p>
<p>这样就能够跑起来（只不过此时由于是 POST 的类型的请求，不支持通过浏览器直接请求）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_ac50d23c5b-image-20220819195359065.png" alt="image-20220819195359065.png"></p>
<p>由于请求是游戏后端 backend 发起的，因此还需要将两部分对接起来。</p>
<p>现在需要创建一个新的子项目，将之前的逻辑装在 backendclound 下面</p>
<h3 id="添加子项目—Backend"><a href="#添加子项目—Backend" class="headerlink" title="添加子项目—Backend"></a>添加子项目—Backend</h3><h4 id="1）添加和配置-1"><a href="#1）添加和配置-1" class="headerlink" title="1）添加和配置"></a>1）添加和配置</h4><p>在<code>backendcloud</code>下面创建<code>SpringCloud</code>的子项目——<code>Backend</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_d3e8bc355b-image-20220819195926647.png" alt="image-20220819195926647.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_dd89ec8a5b-image-20220819200206342.png" alt="image-20220819200206342.png"></p>
<p>然后，将之前的后端<code>backend</code>项目的<code>src</code>整个文件夹直接复制过来。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_e441a4985b-image-20220819200315514.png" alt="image-20220819200315514.png"></p>
<p>复制到<code>backendcloud</code>下面的子模块<code>backend</code>下面</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_ec7973485b-image-20220819200509777.png" alt="image-20220819200509777.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_f3e49ffa5b-image-20220819200446980.png" alt="image-20220819200446980.png"></p>
<p>然后将后端<code>backend</code>项目下的<code>porm.xml</code>中的依赖也粘贴到下面这个位置</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_23d05c125b-image-20220819200735514.png" alt="image-20220819200735514.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_28903f4f5b-image-20220819200848602.png" alt="image-20220819200848602.png"></p>
<p>其中的<code>thymeleaf</code>用不到，删除即可。</p>
<p>目前的项目结构如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_2e3c448e5b-image-20220819205001379.png" alt="image-20220819205001379.png"></p>
<h4 id="2）连通匹配系统"><a href="#2）连通匹配系统" class="headerlink" title="2）连通匹配系统"></a>2）连通匹配系统</h4><p>首先要打通</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_31acd01b5b-image-20220819204842500.png" alt="image-20220819204842500.png"></p>
<p>需要将下面这段修改，目前还只是简单粗暴的进行从集合中取出 User</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_352ad2be5b-image-20220819205339894.png" alt="image-20220819205339894.png"></p>
<p>修改如下：</p>
<p>将与<code>matchpool</code>相关的所有操作都删掉</p>
<p>然后在<code>startMatching()</code>调用时向<code>MatchingSystem</code>发请求，申请为玩家匹配对手，在<code>stopMatching()</code>和<code>onClose()</code> 调用时向<code>MatchingSystem</code>发请求，申请取消玩家的匹配，</p>
<h5 id="配置RestTemplate"><a href="#配置RestTemplate" class="headerlink" title="配置RestTemplate"></a>配置<code>RestTemplate</code></h5><p>向<code>MatchingSystem</code>发请求，需要借助<code>Springboot</code>中的一个工具<code>RestTemplate</code>，它可以在两个 Spring 进程之间进行通信。</p>
<p>先配置一下这个工具，如果希望在<code>WebSocketServer.java</code>中使用<code>RestTemplate</code>，就需要加<code>Bean</code>注解，这样才能够取出来。</p>
<p>可以理解为，需要用到某个工具的时候，就定义一个它的<code>Configuration</code>，加一个注解<code>Bean</code>，返回一个它的实例。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_8845dcc25b-image-20220819211004216.png" alt="image-20220819211004216.png"></p>
<p>这样在未来使用的时候，就可以通过<code>@Autowired</code>将其注入</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_922835c05b-image-20220819211333528.png" alt="image-20220819211333528.png"></p>
<p>原理是，如果加了<code>@Autowired</code>，就会看一下这个接口（或者 Service）是否有一个唯一的注解为<code>Bean</code>的函数和它对应，如果有的话就调用这个函数，将返回值赋过来。</p>
<p>现在看下怎么用。</p>
<p>在具体用之前，需要修改下数据库。将<code>rating</code>字段，将<code>bot</code>表中，移动到<code>user</code>表中</p>
<p>同样，修改这两个表对应的 pojo</p>
<p>并且在所用调用<code>User</code>和<code>Bot</code>构造函数的时候修改</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_963bcfd65b-image-20220819215130236.png" alt="image-20220819215130236.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_9be88c905b-image-20220819215206709.png" alt="image-20220819215206709.png"></p>
<p>然后进入正题。</p>
<h5 id="使用RestTemplate"><a href="#使用RestTemplate" class="headerlink" title="使用RestTemplate"></a>使用<code>RestTemplate</code></h5><p>借助<code>RestTemplate</code>向<code>MatchingSystem</code>发请求</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_9f4a17495b-image-20220819220345823.png" alt="image-20220819220345823.png"></p>
<p>启动 Backend 模块对应的 Spring 服务</p>
<p>此时能够在服务中看到，启动了两个<code>SpringBoot</code></p>
<p><code>Backend</code>对应的端口号为 3000</p>
<p><code>MatchingSystem</code>对应的端口号为 3001</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_a49d38445b-image-20220819224536454.png" alt="image-20220819224536454.png"></p>
<p>用户登录之后，进行匹配，在<code>MatchingSystem</code>对应的控制台下面<code>add player1 1500</code>表示匹配系统接收到了来自后端的玩家 ID 为 6 的匹配请求。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_f210822a5b-image-20220819230223396.png" alt="image-20220819230223396.png"></p>
<p>当点击取消时，同样成功接收到了请求</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_f8ad5f6d5b-image-20220819230259939.png" alt="image-20220819230259939.png"></p>
<p>控制台中看到的输出，是在匹配系统中实现的输出。</p>
<p>至此，游戏后端，向匹配系统发请求这一过程就完成。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_fb932d805b-image-20220819230935439.png" alt="image-20220819230935439.png"></p>
<p>接下来要实现匹配系统内部的逻辑。</p>
<h3 id="匹配系统"><a href="#匹配系统" class="headerlink" title="匹配系统"></a>匹配系统</h3><p>匹配系统在接收到来自游戏后端的匹配请求之后，会将当前参与匹配的所有用户，放在一个池子（数组）里面。开辟额外新线程，每隔 1s 就扫描一遍整个数组，将能够匹配的玩家匹配到一起。我们期望匹配相近分值的玩家，随着时间的推移，可以逐步放宽分值要求，也就是允许两名匹配玩家的分值差距较大，直到所有玩家都可以在规定时间内匹配在一块为止。具体来说，第一秒，匹配分值差距 10 以内的玩家，第二秒，匹配分值差距 20 以内的玩家…..直到匹配完成为止。</p>
<p>现在需要将之前关于线程的那部分再重复一遍。</p>
<p>创建<code>service.impl.utils.MatchingPool</code>用于维护这样一个线程，同时创建<code>service.impl.utils.Player</code>来存储玩家（需要提前将<code>Lombok</code>依赖添加到匹配系统的<code>porm.xml</code>中）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_fd1275bb5b-image-20220819232357797.png" alt="image-20220819232357797.png"></p>
<p>对于<code>Player</code>类，需要考虑三个属性：用户名，积分值，等待时间</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_ffb5ccd75b-image-20220819233045648.png" alt="image-20220819233045648.png"></p>
<h4 id="MatchingPool-线程"><a href="#MatchingPool-线程" class="headerlink" title="MatchingPool 线程"></a>MatchingPool 线程</h4><p>对于<code>MatchingPool</code>，是一个多线程的类，需要继承<code>Thread</code></p>
<ul>
<li>创建一个列表<code>players</code>保存玩家</li>
<li>添加玩家的函数</li>
<li>删除玩家的函数</li>
</ul>
<p>由于<code>players</code>变量多个线程（匹配线程，传入参数线程）共用，因此这个变量涉及到读写冲突，因此就需要加锁。还要注意，从列表中删除元素的时候，要注意重新判断该位置。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_4ad507b25b-image-20220824124004462.png" alt="image-20220824124004462.png"><br>对于匹配系统而言，由于全局只有一个匹配线程，因此将其定义成静态变量，放在<code>MatchingServiceImpl</code>中。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_50c27c0d5b-image-20220824123924024.png" alt="image-20220824123924024.png"></p>
<p>同时在<code>MatchingPool</code>开一个线程，需要重写<code>Thread</code>的<code>run()</code>。对于线程的执行，我们期望周期性的执行，判断当前所有玩家中有没有匹配的。写一个死循环，<code>Thread.sleep(1000)</code>，每 1 秒中自动执行一遍。对于每一名玩家而言，每等待一秒，对应的<code>waitingTime</code>就会加一，相应的匹配阈值就会变大。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_5593b9305b-image-20220824151459662.png" alt="image-20220824151459662.png"></p>
<p>在<code>matchPlayers()</code>中，尝试匹配所有玩家</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_58480ca85b-image-20220824164853700.png" alt="image-20220824164853700.png"></p>
<blockquote>
<p>注意，java 中的 break：跳出当前循环；但是如果是嵌套循环，则只能跳出当前的这一层循环，只有逐层 break 才能跳出所有循环。continue：终止当前循环，但是不跳出循环(在循环中 continue 后面的语句是不会执行了)，继续往下根据循环条件执行循环。</p>
</blockquote>
<p>以上用到的辅助函数</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_5b29aacb5b-image-20220824151636514.png" alt="image-20220824151636514.png"></p>
<h4 id="MatchingSystem发送请求"><a href="#MatchingSystem发送请求" class="headerlink" title="MatchingSystem发送请求"></a><code>MatchingSystem</code>发送请求</h4><p>对于<code>sendResult</code>，负责将匹配的两名玩家作为参数返回到 backend</p>
<p>也就是这个过程</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_5dfa88f55b-image-20220824154705730.png" alt="image-20220824154705730.png"></p>
<p>因为也要用到<code>RestTemplateConfig</code></p>
<p>所以将<code>backend.config.RestTemplateConfig</code>文件复制到<code>matchingsystem.config.RestTemplateConfig</code></p>
<p>为了能让<code>RestTemplateConfig</code>中的<code>Bean</code>注入进来，添加<code>@Component</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_611495b45b-image-20220824155458434.png" alt="image-20220824155458434.png"><br>注入之后，就可以使用<code>RestTemplateConfig</code>来进行<code>SpringBoot</code>服务之间的通信</p>
<p>注意要加端口号</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_a9a65b385b-image-20220824172041862.png" alt="image-20220824172041862.png"></p>
<h4 id="Backend接收请求"><a href="#Backend接收请求" class="headerlink" title="Backend接收请求"></a><code>Backend</code>接收请求</h4><p>为了能将匹配的 a 和 b 作为参数返回到<code>backend</code>，我们需要在<code>backend</code>写一个接收信息的方法</p>
<p>对于这样的一个方法而言，同样的一个流程</p>
<ul>
<li><code>service</code></li>
<li><code>service.impl</code></li>
<li><code>controller</code></li>
</ul>
<p>变动的文件如下，除了<code>SecurityConfig</code>，其他的均为新增文件</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_aef8de9a5b-image-20220824160431231.png" alt="image-20220824160431231.png"></p>
<p><code>StartGameService.java</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_b1936ba35b-image-20220824153546232.png" alt="image-20220824153546232.png"></p>
<p><code>StartGameServiceImpl.java</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_b3c632845b-image-20220824153621228.png" alt="image-20220824153621228.png"><br>其中的<code>WebSocketServer.startGame(aId, bId)</code></p>
<p>内容为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">startGame</span><span class="params">(Integer aId, Integer bId)</span>&#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">userA</span> <span class="operator">=</span> userMapper.selectById(aId);</span><br><span class="line">    <span class="type">User</span> <span class="variable">userB</span> <span class="operator">=</span> userMapper.selectById(bId);</span><br><span class="line">    <span class="type">Game</span> <span class="variable">game</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Game</span>(<span class="number">13</span>,<span class="number">14</span>,<span class="number">20</span>, userA.getId(), userB.getId());</span><br><span class="line">    game.createMap();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//game是属于A和B两个玩家 因此需要赋值给A和B两名玩家对应的连接上</span></span><br><span class="line">    userConnectionInfo.get(userA.getId()).game = game;</span><br><span class="line">    userConnectionInfo.get(userB.getId()).game = game;</span><br><span class="line"></span><br><span class="line">    game.start();<span class="comment">//开辟一个新的线程</span></span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">respGame</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    respGame.put(<span class="string">&quot;a_id&quot;</span>,game.getPlayerA().getId());</span><br><span class="line">    respGame.put(<span class="string">&quot;a_sx&quot;</span>,game.getPlayerA().getSx());</span><br><span class="line">    respGame.put(<span class="string">&quot;a_sy&quot;</span>,game.getPlayerA().getSy());</span><br><span class="line">    respGame.put(<span class="string">&quot;b_id&quot;</span>,game.getPlayerB().getId());</span><br><span class="line">    respGame.put(<span class="string">&quot;b_sx&quot;</span>,game.getPlayerB().getSx());</span><br><span class="line">    respGame.put(<span class="string">&quot;b_sy&quot;</span>,game.getPlayerB().getSy());</span><br><span class="line">    respGame.put(<span class="string">&quot;map&quot;</span>,game.getG());<span class="comment">//两名玩家的地图一致</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//分别给userA和userB传送消息告诉他们匹配成功了</span></span><br><span class="line">    <span class="comment">//通过userA的连接向userA发消息</span></span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">respA</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    respA.put(<span class="string">&quot;event&quot;</span>,<span class="string">&quot;start-matching&quot;</span>);</span><br><span class="line">    respA.put(<span class="string">&quot;opponent_username&quot;</span>,userB.getUsername());</span><br><span class="line">    respA.put(<span class="string">&quot;opponent_photo&quot;</span>,userB.getPhoto());</span><br><span class="line">    respA.put(<span class="string">&quot;game&quot;</span>,respGame);</span><br><span class="line">    <span class="type">WebSocketServer</span> <span class="variable">webSocketServer1</span> <span class="operator">=</span> userConnectionInfo.get(userA.getId());<span class="comment">//获取user1的连接</span></span><br><span class="line">    webSocketServer1.sendMessage(respA.toJSONString());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过userB的连接向userB发消息</span></span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">respB</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    respB.put(<span class="string">&quot;event&quot;</span>,<span class="string">&quot;start-matching&quot;</span>);</span><br><span class="line">    respB.put(<span class="string">&quot;opponent_username&quot;</span>,userA.getUsername());</span><br><span class="line">    respB.put(<span class="string">&quot;opponent_photo&quot;</span>,userA.getPhoto());</span><br><span class="line">    respB.put(<span class="string">&quot;game&quot;</span>,respGame);</span><br><span class="line">    <span class="type">WebSocketServer</span> <span class="variable">webSocketServer2</span> <span class="operator">=</span> userConnectionInfo.get(userB.getId());</span><br><span class="line">    webSocketServer2.sendMessage(respB.toJSONString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>StartGameController.java</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_10e02a3f5b-image-20220824153753802.png" alt="image-20220824153753802.png"></p>
<p><code>SecurityConfig.java</code>，对于<code>&quot;/pk/start/game/&quot;</code>这样一个 URL，只允许本地调用。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_4e2742785b-image-20220824153836952.png" alt="image-20220824153836952.png"><br>这样<code>backend</code>端的接收函数就实现了</p>
<h4 id="匹配池启动"><a href="#匹配池启动" class="headerlink" title="匹配池启动"></a>匹配池启动</h4><p>这样一个匹配池线程我们选择在 Springboot 启动之前随之启动</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_1444a8765b-image-20220824105744026.png" alt="image-20220824105744026.png"></p>
<h4 id="Debug-调试"><a href="#Debug-调试" class="headerlink" title="Debug 调试"></a>Debug 调试</h4><p>启动<code>MatchingSystem</code>所对应的<code>SpringBoot</code>服务，可以看到，每秒就会执行一次<code>matchPlayers()</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_18d2b1925b-image-20220824163955389.png" alt="image-20220824163955389.png"></p>
<p>现在前端一个玩家点击“匹配”按钮</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_5a106a725b-image-20220824164454541.png" alt="image-20220824164454541.png"></p>
<p>可以看到对应的<code>waitingTime</code>每隔一秒加 1</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_5dc7fd725b-image-20220824164635862.png" alt="image-20220824164635862.png"><br>点击取消之后，就会删除。</p>
<p>之后测试两个用户</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_8cb44d955b-image-20220824170756125.png" alt="image-20220824170756125.png"></p>
<p>很快实现匹配</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_90483c2e5b-image-20220824170730058.png" alt="image-20220824170730058.png"></p>
<p>为了便于测试，将两名玩家的分值差距调大。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_92c04c855b-image-20220824171202665.png" alt="image-20220824171202665.png"></p>
<p>分差 100，根据匹配规则，需要满足与自己的分值差距，小于自己的等待时间*10，</p>
<p>ratingDelta &lt;= waitingTime * 10; (ratingDelta = 100)</p>
<p>意味着</p>
<p>waitingTime &gt;= 10</p>
<p>因此，需要两名玩家的等待时间都&gt;=10 的时候，两者匹配。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_95a22d8e5b-image-20220824171226445.png" alt="image-20220824171226445.png"></p>
<p>测试结果如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_98a9fb8f5b-image-20220824171939710.png" alt="image-20220824171939710.png"></p>
<h4 id="老板模式"><a href="#老板模式" class="headerlink" title="老板模式"></a>老板模式</h4><p>有些时候玩家匹配成功之后，游戏过程中，突然老板进来了，然后此时立刻关闭网页。也就是不通过请求的方式想匹配系统发起取消匹配，而是直接断开连接。</p>
<p>也就是针对：玩家在匹配池，但是玩家已经断开连接</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_db5cd3475b-image-20220824173157365.png" alt="image-20220824173157365.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_e0263ba75b-image-20220824173522989.png" alt="image-20220824173522989.png"></p>
<p>如上，报异常的原因是因为，<code>userConnectionInfo.get(userA.getId())</code>返回的是一个空对象，然后空对象是没有<code>game</code>属性的，所以会报错。</p>
<p>因此这里需要加一些判断。如果已经断开连接，还是将其匹配到一起，但是 6 秒之内没有接收到操作就会判输。</p>
<p><code>WebSocketServer.java</code></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_e28ea2215b-image-20220824174716195.png" alt="image-20220824174716195.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_e59561c85b-image-20220824174748271.png" alt="image-20220824174748271.png"></p>
<p>同时，<code>consumer.utils.Game.java</code>也要添加判断</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/11/03/127575_e97be7c95b-image-20220824175133843.png" alt="image-20220824175133843.png"></p>
<p>如果已经断开连接，还是将其匹配到一起（不报异常），但是 6 秒之内没有接收到操作就会判输。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://104483264.github.io/">陈文彬</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://104483264.github.io/posts/c0a8ef92.html">https://104483264.github.io/posts/c0a8ef92.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://104483264.github.io" target="_blank">卑微小陈的Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/springboot/">springboot</a></div><div class="post_share"><div class="social-share" data-image="https://w.wallhaven.cc/full/jx/wallhaven-jx9gyy.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><link rel="stylesheet" href="/css/coin/coin.css" media="defer" onload="this.media='all'"/><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">卑微小陈在线乞讨</span><div class="coin-wrapper"><div class="coin"><div class="coin__middle"></div><div class="coin__back"></div><div class="coin__front"></div></div></div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://cdn.acwing.com/media/article/image/2022/10/31/127575_9ad32ca759-wx.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/10/31/127575_9ad32ca759-wx.png" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="https://cdn.acwing.com/media/article/image/2022/10/31/127575_b388dd8a59-ali.png" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.acwing.com/media/article/image/2022/10/31/127575_b388dd8a59-ali.png" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></button></div><audio id="coinAudio" src="https://cdn.cbd.int/akilar-candyassets@1.0.36/audio/aowu.m4a"></audio><script defer="defer" src="/js/coin/coin.js"></script><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/7a87d6c7.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://w.wallhaven.cc/full/vq/wallhaven-vqml88.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">acwing-springboot 7. 实现微服务：Bot代码的执行</div></div></a></div><div class="next-post pull-right"><a href="/posts/37a68d15.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://w.wallhaven.cc/full/l8/wallhaven-l8967r.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">acwing-springboot 创建个人中心页面(下)</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/6482513a.html" title="springboot入门"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://w.wallhaven.cc/full/p9/wallhaven-p93gm9.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-14</div><div class="title">springboot入门</div></div></a></div><div><a href="/posts/5ea8a16.html" title="acwing-springboot 配置Mysql与注册登录模块（下）"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://w.wallhaven.cc/full/9d/wallhaven-9dxv78.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-30</div><div class="title">acwing-springboot 配置Mysql与注册登录模块（下）</div></div></a></div><div><a href="/posts/2ebdbc54.html" title="acwing-springboot 创建个人中心页面(上)"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://w.wallhaven.cc/full/l8/wallhaven-l8qy8l.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-31</div><div class="title">acwing-springboot 创建个人中心页面(上)</div></div></a></div><div><a href="/posts/bd56ed73.html" title="acwing-springboot 配置Mysql与注册登录模块（上）"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://w.wallhaven.cc/full/6d/wallhaven-6djzl7.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-28</div><div class="title">acwing-springboot 配置Mysql与注册登录模块（上）</div></div></a></div><div><a href="/posts/37a68d15.html" title="acwing-springboot 创建个人中心页面(下)"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://w.wallhaven.cc/full/l8/wallhaven-l8967r.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-01</div><div class="title">acwing-springboot 创建个人中心页面(下)</div></div></a></div><div><a href="/posts/80b37af4.html" title="acwing-springboot 配置Mysql与注册登录模块（中）"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://w.wallhaven.cc/full/kx/wallhaven-kx36mq.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-29</div><div class="title">acwing-springboot 配置Mysql与注册登录模块（中）</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">卑微小陈</div><div class="author-info__description">一个爱学习的好孩子写的博客</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">18</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">2</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/104483264" target="_blank" title="Github"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-gitHub"></use></svg></a><a class="social-icon faa-parent animated-hover" href="https://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=1044823264@qq.com" target="_blank" title="Email"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-youxiang"></use></svg></a><a class="social-icon faa-parent animated-hover" href="/atom.xml" target="_blank" title="RSS"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-rss"></use></svg></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/510951283" target="_blank" title="BiliBili"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-bilibili"></use></svg></a><a class="social-icon faa-parent animated-hover" href="tencent://Message/?Uin=1044823264&amp;amp;websiteName=local.edu.com:8888=&amp;amp;Menu=yes" target="_blank" title="QQ"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-QQ1"></use></svg></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">流程分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#websocket-%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.</span> <span class="toc-text">websocket 原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E6%88%90-WebSocket"><span class="toc-number">2.</span> <span class="toc-text">集成 WebSocket</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E8%B0%83%E8%AF%95"><span class="toc-number">3.</span> <span class="toc-text">接口调试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5"><span class="toc-number">3.1.</span> <span class="toc-text">建立连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Jwt-%E9%AA%8C%E8%AF%81"><span class="toc-number">3.2.</span> <span class="toc-text">Jwt 验证</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.</span> <span class="toc-text">前端实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8C%B9%E9%85%8D%E6%B5%8B%E8%AF%95"><span class="toc-number">4.1.</span> <span class="toc-text">匹配测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%B0%E5%9B%BE%E5%90%8C%E6%AD%A5"><span class="toc-number">5.</span> <span class="toc-text">地图同步</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%A9%E5%AE%B6%E4%BD%8D%E7%BD%AE%E5%90%8C%E6%AD%A5"><span class="toc-number">6.</span> <span class="toc-text">玩家位置同步</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E4%BF%AE%E6%94%B9"><span class="toc-number">6.1.</span> <span class="toc-text">后端修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E4%BF%AE%E6%94%B9"><span class="toc-number">6.2.</span> <span class="toc-text">前端修改</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B8%B8%E6%88%8F%E5%90%8C%E6%AD%A5%EF%BC%9A%E5%A4%9A%E7%BA%BF%E7%A8%8B"><span class="toc-number">7.</span> <span class="toc-text">游戏同步：多线程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E8%BF%87%E7%A8%8B"><span class="toc-number">7.1.</span> <span class="toc-text">分析过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B"><span class="toc-number">7.2.</span> <span class="toc-text">多线程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E5%90%8E%E7%AB%AF%E9%80%9A%E4%BF%A1"><span class="toc-number">7.3.</span> <span class="toc-text">前后端通信</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-event-move"><span class="toc-number">7.4.</span> <span class="toc-text">1) event &#x3D;&#x3D; move</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-event-result"><span class="toc-number">7.5.</span> <span class="toc-text">2) event &#x3D;&#x3D; result</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B8%B8%E6%88%8F%E7%BB%93%E6%9E%9C%E5%B1%95%E7%A4%BA"><span class="toc-number">7.6.</span> <span class="toc-text">游戏结果展示</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E5%B1%80%E8%AE%B0%E5%BD%95"><span class="toc-number">8.</span> <span class="toc-text">对局记录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-record"><span class="toc-number">8.1.</span> <span class="toc-text">创建 record</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">8.2.</span> <span class="toc-text">写入数据库</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">9.</span> <span class="toc-text">实现匹配系统的微服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BASpringCloud%E9%A1%B9%E7%9B%AE"><span class="toc-number">9.1.</span> <span class="toc-text">创建SpringCloud项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AESpringCloud%E9%A1%B9%E7%9B%AE"><span class="toc-number">9.2.</span> <span class="toc-text">配置SpringCloud项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E5%AD%90%E9%A1%B9%E7%9B%AE%E2%80%94MatchingSystem"><span class="toc-number">9.3.</span> <span class="toc-text">添加子项目—MatchingSystem</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E6%B7%BB%E5%8A%A0%E5%92%8C%E9%85%8D%E7%BD%AE"><span class="toc-number">9.3.1.</span> <span class="toc-text">1）添加和配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%AE%80%E5%8D%95%E5%B8%83%E5%B1%80"><span class="toc-number">9.3.2.</span> <span class="toc-text">2）匹配系统的简单布局</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E5%AD%90%E9%A1%B9%E7%9B%AE%E2%80%94Backend"><span class="toc-number">9.4.</span> <span class="toc-text">添加子项目—Backend</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E6%B7%BB%E5%8A%A0%E5%92%8C%E9%85%8D%E7%BD%AE-1"><span class="toc-number">9.4.1.</span> <span class="toc-text">1）添加和配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E8%BF%9E%E9%80%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F"><span class="toc-number">9.4.2.</span> <span class="toc-text">2）连通匹配系统</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AERestTemplate"><span class="toc-number">9.4.2.1.</span> <span class="toc-text">配置RestTemplate</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8RestTemplate"><span class="toc-number">9.4.2.2.</span> <span class="toc-text">使用RestTemplate</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F"><span class="toc-number">9.5.</span> <span class="toc-text">匹配系统</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MatchingPool-%E7%BA%BF%E7%A8%8B"><span class="toc-number">9.5.1.</span> <span class="toc-text">MatchingPool 线程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MatchingSystem%E5%8F%91%E9%80%81%E8%AF%B7%E6%B1%82"><span class="toc-number">9.5.2.</span> <span class="toc-text">MatchingSystem发送请求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Backend%E6%8E%A5%E6%94%B6%E8%AF%B7%E6%B1%82"><span class="toc-number">9.5.3.</span> <span class="toc-text">Backend接收请求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%B9%E9%85%8D%E6%B1%A0%E5%90%AF%E5%8A%A8"><span class="toc-number">9.5.4.</span> <span class="toc-text">匹配池启动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Debug-%E8%B0%83%E8%AF%95"><span class="toc-number">9.5.5.</span> <span class="toc-text">Debug 调试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%80%81%E6%9D%BF%E6%A8%A1%E5%BC%8F"><span class="toc-number">9.5.6.</span> <span class="toc-text">老板模式</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/7a87d6c7.html" title="acwing-springboot 7. 实现微服务：Bot代码的执行"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://w.wallhaven.cc/full/vq/wallhaven-vqml88.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="acwing-springboot 7. 实现微服务：Bot代码的执行"/></a><div class="content"><a class="title" href="/posts/7a87d6c7.html" title="acwing-springboot 7. 实现微服务：Bot代码的执行">acwing-springboot 7. 实现微服务：Bot代码的执行</a><time datetime="2022-11-29T12:00:00.000Z" title="发表于 2022-11-29 20:00:00">2022-11-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/c0a8ef92.html" title="acwing-springboot 6. 实现微服务：匹配系统"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://w.wallhaven.cc/full/jx/wallhaven-jx9gyy.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="acwing-springboot 6. 实现微服务：匹配系统"/></a><div class="content"><a class="title" href="/posts/c0a8ef92.html" title="acwing-springboot 6. 实现微服务：匹配系统">acwing-springboot 6. 实现微服务：匹配系统</a><time datetime="2022-11-02T16:25:00.000Z" title="发表于 2022-11-03 00:25:00">2022-11-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/37a68d15.html" title="acwing-springboot 创建个人中心页面(下)"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://w.wallhaven.cc/full/l8/wallhaven-l8967r.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="acwing-springboot 创建个人中心页面(下)"/></a><div class="content"><a class="title" href="/posts/37a68d15.html" title="acwing-springboot 创建个人中心页面(下)">acwing-springboot 创建个人中心页面(下)</a><time datetime="2022-10-31T16:30:00.000Z" title="发表于 2022-11-01 00:30:00">2022-11-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/2ebdbc54.html" title="acwing-springboot 创建个人中心页面(上)"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://w.wallhaven.cc/full/l8/wallhaven-l8qy8l.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="acwing-springboot 创建个人中心页面(上)"/></a><div class="content"><a class="title" href="/posts/2ebdbc54.html" title="acwing-springboot 创建个人中心页面(上)">acwing-springboot 创建个人中心页面(上)</a><time datetime="2022-10-31T05:00:00.000Z" title="发表于 2022-10-31 13:00:00">2022-10-31</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/5ea8a16.html" title="acwing-springboot 配置Mysql与注册登录模块（下）"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://w.wallhaven.cc/full/9d/wallhaven-9dxv78.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="acwing-springboot 配置Mysql与注册登录模块（下）"/></a><div class="content"><a class="title" href="/posts/5ea8a16.html" title="acwing-springboot 配置Mysql与注册登录模块（下）">acwing-springboot 配置Mysql与注册登录模块（下）</a><time datetime="2022-10-30T07:30:00.000Z" title="发表于 2022-10-30 15:30:00">2022-10-30</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By 卑微小陈</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://ky.cwbnb.top/',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://ky.cwbnb.top/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><div class="aplayer no-destroy" data-id="1708664797" data-server="tencent" data-type="playlist"   data-order="list" data-fixed="true" data-preload="auto" data-autoplay="false" data-mutex="true" ></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><div class="app-refresh" id="app-refresh" style="position: fixed;top: -2.2rem;left: 0;right: 0;z-index: 99999;padding: 0 1rem;font-size: 15px;height: 2.2rem;transition: all 0.3s ease;"><div class="app-refresh-wrap" style=" display: flex;color: #fff;height: 100%;align-items: center;justify-content: center;"><label>✨ 有新文章啦！ 👉</label><a href="javascript:void(0)" onclick="location.reload()"><span style="color: #fff;text-decoration: underline;cursor: pointer;">🍗点击食用🍔</span></a></div></div><script>if ('serviceWorker' in navigator) {
if (navigator.serviceWorker.controller) {
navigator.serviceWorker.addEventListener('controllerchange', function() {
showNotification()
})
}
window.addEventListener('load', function() {
navigator.serviceWorker.register('/sw.js')
})
}
function showNotification() {
if (GLOBAL_CONFIG.Snackbar) {
var snackbarBg =
document.documentElement.getAttribute('data-theme') === 'light' ?
GLOBAL_CONFIG.Snackbar.bgLight :
GLOBAL_CONFIG.Snackbar.bgDark
var snackbarPos = GLOBAL_CONFIG.Snackbar.position
Snackbar.show({
text: '✨ 有新文章啦！ 👉',
backgroundColor: snackbarBg,
duration: 500000,
pos: snackbarPos,
actionText: '🍗点击食用🍔',
actionTextColor: '#fff',
onActionClick: function(e) {
location.reload()
},
})
} else {
var showBg =
document.documentElement.getAttribute('data-theme') === 'light' ?
'#425aef' :
'#1f1f1f'
var cssText = `top: 0; background: ${showBg};`
document.getElementById('app-refresh').style.cssText = cssText
}
}</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_clock_anzhiyu_injector_config(){
    var parent_div_git = document.getElementsByClassName('sticky_layout')[0];
    var item_html = '<div class="card-widget card-clock"><div class="card-glass"><div class="card-background"><div class="card-content"><div id="hexo_electric_clock"><img class="entered loading" id="card-clock-loading" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu@1.1.8/lib/loading.gif" style="height: 120px; width: 100%;" data-ll-status="loading"/></div></div></div></div></div>';
    console.log('已挂载butterfly_clock_anzhiyu')
    if(parent_div_git) {
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var qweather_key = '7e71f725c7b74f059102010b4b4a876b';
  var gaud_map_key = '899d624b2226d3fd390b19f852877f55';
  var baidu_ak_key = 'undefined';
  var flag = 0;
  var clock_rectangle = '112.982279,28.19409';
  var clock_default_rectangle_enable = 'false';

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_clock_anzhiyu_injector_config();
  }
  else if (epage === cpage){
    butterfly_clock_anzhiyu_injector_config();
  }
  </script><script src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script><script data-pjax src="https://cdn.cbd.int/hexo-butterfly-clock-anzhiyu@1.1.8/lib/clock.min.js"></script><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v5.4.0" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" data-title="主题版本Butterfly_v4.2.2" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="https://www.jsdelivr.com/" style="margin-inline:5px" data-title="本站使用JsDelivr为静态资源提供CDN加速" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&amp;logo=jsDelivr" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="本站项目由Github托管" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" alt=""/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可" title=""><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></p>';
    console.log('已挂载butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><script async src="/js/runtime/runtime.min.js"></script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '1.5s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('flink-list-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__flipInY');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('flink-list-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__animated');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('article-sort-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__slideInRight');
    arr[i].setAttribute('data-wow-duration', '1.5s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('site-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__flipInY');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script><script async="async">var arr = document.getElementsByClassName('site-card');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__animated');
    arr[i].setAttribute('data-wow-duration', '3s');
    arr[i].setAttribute('data-wow-delay', '');
    arr[i].setAttribute('data-wow-offset', '');
    arr[i].setAttribute('data-wow-iteration', '');
  }</script></div><script defer src="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://cdn.cbd.int/hexo-butterfly-wowjs/lib/wow_init.js"></script><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item swiper_container_card" style="height: auto;width: 100%"><div id="random"><div id="random-banner"><canvas id="peoplecanvas"></canvas></div><a id="random-hover" style="width:100%;height:auto;" href="javascript:toRandomPost()" rel="external nofollow noreferrer" one-link-mark="yes"><i class="fa fa-paper-plane" style="margin-left:10px"></i><div style="margin-left:10px">随便逛逛<i class="fa-solid fa-arrow-right" style="margin-left:10px"></i></div></a></div><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/270eeb2d.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://w.wallhaven.cc/full/ex/wallhaven-exze68.jpg" alt="" onerror="this.src=https://cdn.cbd.int/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-10-16</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/270eeb2d.html&quot;);" href="javascript:void(0);" alt="">mybatis-plus入门</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/270eeb2d.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/6482513a.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://w.wallhaven.cc/full/p9/wallhaven-p93gm9.jpg" alt="" onerror="this.src=https://cdn.cbd.int/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-10-14</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/6482513a.html&quot;);" href="javascript:void(0);" alt="">springboot入门</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/6482513a.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/91794a99.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://w.wallhaven.cc/full/57/wallhaven-571998.png" alt="" onerror="this.src=https://cdn.cbd.int/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-10-08</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/91794a99.html&quot;);" href="javascript:void(0);" alt="">ssm整合</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/91794a99.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/b824cc2f.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://w.wallhaven.cc/full/g7/wallhaven-g7319l.png" alt="" onerror="this.src=https://cdn.cbd.int/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-10-06</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/b824cc2f.html&quot;);" href="javascript:void(0);" alt="">springMVC入门</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/b824cc2f.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/dd9a467d.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://w.wallhaven.cc/full/l3/wallhaven-l39w52.jpg" alt="" onerror="this.src=https://cdn.cbd.int/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2022-10-04</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/dd9a467d.html&quot;);" href="javascript:void(0);" alt="">spring第一天</a><div class="blog-slider__text">再怎么看我也不知道怎么描述它的啦！</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/dd9a467d.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('已挂载butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = '/';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/js/swiper.min.js"></script><script defer data-pjax src="https://cdn.cbd.int/hexo-butterfly-swiper-anzhiyu@1.0.4/lib/swiper_init.js"></script><script data-pjax src="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/gsap/3.9.1/gsap.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper-anzhiyu@1.0.4/lib/people.min.js"></script><script async src="/anzhiyu/random.js"></script><script data-pjax src="https://cdn.cbd.int/hexo-filter-gitcalendar/lib/gitcalendar.js"></script><script data-pjax>
  function gitcalendar_injector_config(){
      var parent_div_git = document.getElementById('recent-posts');
      var item_html = '<div class="recent-post-item" style="width:100%;height:auto;padding:10px;"><style>#git_container{min-height: 280px}@media screen and (max-width:650px) {#git_container{min-height: 0px}}</style><div id="git_loading" style="width:10%;height:100%;margin:0 auto;display: block;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animatetransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animatetransform></path></svg><style>#git_container{display: none;}</style></div><div id="git_container"></div></div>';
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      console.log('已挂载gitcalendar')
      }

    if( document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
        gitcalendar_injector_config()
        GitCalendarInit("https://github.anzhiy.cn/api?104483264",['#ebedf0', '#fdcdec', '#fc9bd9', '#fa6ac5', '#f838b2', '#f5089f', '#c4067e', '#92055e', '#540336', '#48022f', '#30021f'],'104483264')
    }
  </script><script async src="/js/ali_font.js"></script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/"});</script></body></html>